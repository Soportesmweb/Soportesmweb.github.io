<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Generador de Notificaciones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        
        body {
            font-family: 'Inter', sans-serif; 
            background-color: #f0f2f5; 
            display: flex;
            justify-content: center;
            align-items: flex-start; 
            min-height: 100vh; 
            padding: 20px; 
        }
        .container {
            background-color: #ffffff; 
            padding: 30px;
            border-radius: 12px; 
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); 
            max-width: 900px; 
            width: 100%; 
            margin-top: 20px; 
            position: relative; 
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600; 
            color: #333; 
        }
        input[type="text"],
        input[type="datetime-local"], 
        textarea,
        select {
            width: 100%; 
            padding: 12px;
            margin-bottom: 20px; 
            border: 1px solid #e2e8f0; 
            border-radius: 8px; 
            box-sizing: border-box; 
            font-size: 1rem; 
            transition: border-color 0.3s ease; 
        }
        input[type="text"]:focus,
        input[type="datetime-local"]:focus, 
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #6366f1; 
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); 
        }
        textarea {
            resize: vertical; 
            min-height: 60px; 
        }
        
        button {
            background-color: #a0aec0; /* Fondo gris por defecto */
            color: white;
            padding: 14px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem; 
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease; 
            width: auto; 
            display: inline-block; 
            margin-right: 15px; 
        }
        button:hover {
            background-color: #efb810; /* Color al pasar el puntero */
            transform: translateY(-2px); 
        }
        button:active {
            transform: translateY(0); 
        }
        
        #resultado {
            border: 2px dashed #cbd5e1; 
            padding: 25px;
            margin-top: 30px;
            background-color: #f8fafc; 
            border-radius: 10px;
            min-height: 150px; 
            color: #333;
            line-height: 1.6; 
        }
        #resultado h3 {
            font-size: 1.8rem;
            color: #1a202c;
            margin-bottom: 15px;
            border-bottom: 2px solid #e2e8f0; 
            padding-bottom: 10px;
        }
        #resultado p {
            margin-bottom: 10px;
        }
        #resultado strong {
            color: #4a5568;
        }
        
        .optional-field {
            margin-bottom: 20px;
            display: flex;
            align-items: center; 
        }
        .optional-field input[type="checkbox"] {
            width: auto; 
            margin-right: 10px; 
            margin-bottom: 0; 
        }
        .optional-field label {
            margin-bottom: 0; 
        }
        
        #enviarCorreoBtn {
            display: none;
        }
        
        .logo-img {
            position: absolute; 
            top: 10px; 
            left: 30px; 
            /width: 200px; 
            height: 80px; 
            object-fit: contain; 
        }
        
        select[multiple] {
            min-height: 100px; 
        }
        
        .country-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .country-item img {
            width: 38px;
            height: 26px;
            margin-left: 6px;
            border: 1px solid #ccc; 
        }
        
        .section-container {
            background-color: #e0f2f7; 
            padding: 24px; 
            margin-bottom: 24px; 
            border-radius: 10px; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); 
        }
        
        .servicio-porcentaje-item {
            display: flex;
            align-items: center;
            gap: 10px; 
            margin-top: 10px; 
        }
        .servicio-porcentaje-item input {
            width: 80px; 
            padding: 8px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        
        .notification-table {
            width: 100%;
            border-collapse: collapse; 
            margin-top: 20px;
        }
        .notification-table th,
        .notification-table td {
            padding: 10px 15px;
            border: 1px solid #e2e8f0; 
            text-align: left;
        }
        .notification-table th {
            background-color: #f0f4f8; 
            font-weight: 600;
            color: #2c5282; 
        }
        .blue-border-table {
            border: 2px solid #3182ce; 
        }
        .red-border-table {
            border: 2px solid #e53e3e; 
        }
        .notification-table tr:nth-child(even) {
            background-color: #f7fafc; 
        }
        .notification-table strong {
            color: #1a202c; 
        }
        
        .dynamic-image {
            max-width: 80px; 
            height: auto;
            margin-top: 10px;
            
        }
        .platform-images-container {
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
            margin-top: 10px;
            justify-content: center; 
        }
        .platform-images-container .platform-item {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.8rem;
            color: #555;
            width: 90px;
        }
        .platform-images-container .platform-item img {
            max-width: 80px;
            height: auto;
            margin-bottom: 4px;
        }
        .platform-images-container .platform-item span {
            display: block;
            text-align: center;
            width: 100%;
            margin-top: 4px;
            font-weight: 500;
        }

        
        .flag-images-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px; 
            margin-top: 5px;
            align-items: center; 
        }
        .flag-images-container .flag-item {
            display: flex;
            flex-direction: column; 
            align-items: center;
            text-align: center;
            font-size: 0.8rem;
            color: #555;
        }
        .flag-images-container img {
            width: 64px; 
            height: 44px;
            border: 1px solid #eee;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 4px; 
        }

        
        .orange-border-box {
            border: 3px solid #f97316; 
            padding: 15px;
            border-radius: 10px;
            flex-grow: 1; 
        }
        .blue-border-box {
            border: 3px solid #3b82f6; 
            padding: 20px;
            border-radius: 8px;
            flex-grow: 1; 
        }
        .flex-container-middle {
            display: flex;
            flex-wrap: wrap; 
            gap: 20px; 
            justify-content: space-around; 
            align-items: flex-start; 
        }
        .flex-item-middle {
            flex: 1; 
            min-width: 250px; 
        }

        
        .preview-section-title {
            font-size: 1.0rem; 
            font-weight: bold; 
            margin-bottom: 5px; 
            color: #1a202c; 
        }

        
        .preview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            border: 1px solid #ffffff; 
            background-color: #ffffff; 
        }
        .preview-grid-cell {
            background-color: #ffffff; 
            padding: 10px;
            display: flex; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .preview-grid-cell.spanning-row {
            grid-column: span 2; 
            text-align: center;
            align-items: flex-start;
            padding: 13px;
        }
        .preview-grid-cell.spanning-row.content-only {
             padding: 15px; 
             text-align: left;
             align-items: flex-start;
        }
        .preview-grid-cell .logo-container {
            display: flex;
            align-items: center;
            width: 100%;
            
        }
        .preview-grid-cell .logo-container img {
	    justify-content: left;
            max-width: 400px; 
            height: 400px; 
            object-fit: contain;
        }
        .preview-grid-cell .type-notification-image {
            justify-content: right;
	    max-width: 110px; 
            height: 110px; 
            object-fit: contain; 
            margin-top: 10;
        }
        .preview-grid-cell h4 {
            font-size: 1.2rem; 
            font-weight: bold;
            margin: 10px 0;
            text-align: center;
            width: 100%;
	    color: #3a73bd;
        }
        .preview-grid-cell .platform-images-container {
            justify-content: center; 
            display: flex; 
            flex-wrap: wrap;
            gap: 10px;
            width: 100%; 
        }
        .platform-images-container .platform-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.8rem;
            color: #555;
            width: 110px; /* MODIFIED: Increased width for larger images */
        }
        .platform-images-container .platform-item img {
            display: block;
            margin: 0 auto 4px auto;
            max-width: 80px;
            height: auto;
        }
        .platform-images-container .platform-item span {
            display: block;
            text-align: center;
            width: 100%;
            margin-top: 4px;
            font-weight: 500;
        }
        .preview-grid-cell .platform-images-container img {
            max-width: 70px; /* MODIFIED: Increased image size by 25% (80px -> 100px) */
            height: auto;
            display: block; 
        }
        .preview-grid-cell .description-text,
        .preview-grid-cell .considerations-text {
            font-size: 1rem;
            line-height: 1.3;
            text-align: left;
            width: 100%;
            font-weight: normal; 
            color: #333;
        }
        .preview-grid-cell .description-text strong,
        .preview-grid-cell .considerations-text strong {
            font-weight: bold;
            color: #1a202c;
        }
        .preview-grid-cell .flag-images-container {
            justify-content: center; 
            width: 100%;
        }
        .preview-grid-cell .flag-images-container img {
            width: 48px; 
            height: 32px;
        }
        .preview-grid-cell .flag-images-container .flag-item span {
            font-size: 0.7rem; 
        }
        .preview-section-content {
            font-size: 0.8rem;
            text-align: left;
            width: 100%;
            margin-left: 30px;
        }
        .preview-section-content strong {
            font-weight: bold;
        }

        
        .orange-bordered-cell {
            border: 5px solid #f97316; 
            border-radius: 8px; 
            box-sizing: border-box; 
        }

        
        .row-span-2 {
            grid-row: span 2;
        }

        
        .email-container .preview-grid-cell .logo-container img,
        .email-container .preview-grid-cell .type-notification-image {
            height: 60px; 
        }

    
#resultado {
    background: url('fondomsco.png') center center no-repeat;
    background-size: cover;
    crossorigin="anonymous"
}
.preview-grid-cell {
    background-color: rgba(255, 255, 255, 0.85); /* blanco semi-transparente */
}


/* === MODIFICACIONES PERSONALIZADAS === */
/* 1. Íconos 25% más pequeños */
.preview-grid-cell .type-notification-image {
    max-width: 82px !important;
    height: 82px !important;
    object-fit: contain;
}
/* 2. Texto de tipo antes del título */
.tipo-notificacion-texto {
    display: block;
    color: #3a73bd;
    font-size: 1.1rem;
    font-weight: bold;
    text-align: center;
    margin-bottom: 2px;
    width: 100%;
}
/* 3. Espacio mínimo entre imágenes y título */
#resultado .preview-grid { gap: 6px !important; }
#resultado .preview-grid-cell { padding: 4px !important; }

</style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
/* 1) Logo de Speedy en la previsualización: pegado al margen del área blanca */
#resultado .preview-grid .preview-grid-cell:first-child { 
  padding: 0 !important;
}
#resultado .preview-grid .preview-grid-cell:first-child > * {
  margin: 0 !important;
  padding: 0 !important;
}
#resultado .preview-grid .preview-grid-cell:first-child img {
  display: block;
  margin: 0 !important;
  height: 60px;            /* respeta la altura original del diseño */
  object-fit: contain;
}

/* 2) Espacio mínimo entre secciones en la previsualización */
#resultado .preview-grid { 
  gap: 8px !important;     /* antes 20px */
}
#resultado .preview-grid-cell { 
  padding: 6px !important; /* antes 10px */
  margin: 0 !important;
}
#resultado .preview-grid-cell.spanning-row,
#resultado .preview-grid-cell.content-only {
  padding: 8px !important; /* antes 15px */
}

/* Títulos y párrafos más compactos dentro del resultado */
#resultado .preview-section-title { 
  margin-bottom: 4px !important;
}
#resultado p { 
  margin-bottom: 4px !important;
}

/* Contenido de secciones tipo "Horario", etc. más cercano al título */
#resultado .preview-section-content {
  margin-left: 10px !important; /* antes 30px */
}
</style>

</head>
<body>
<script>const USERNAME = "admin"; const PASSWORD = "12345"; document.write(` <div id="loginOverlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#f0f2f5;display:flex;justify-content:center;align-items:center;z-index:9999;"> <div style="background:#fff;padding:30px;border-radius:12px;box-shadow:0 5px 20px rgba(0,0,0,0.2);text-align:center;max-width:300px;"> <h2 style="margin-bottom:20px;color:#333;">Acceso Restringido</h2> <input type="text" id="loginUser" placeholder="Usuario" style="width:100%;margin-bottom:10px;padding:10px;border:1px solid #ccc;border-radius:6px;"><br> <input type="password" id="loginPass" placeholder="Contraseña" style="width:100%;margin-bottom:15px;padding:10px;border:1px solid #ccc;border-radius:6px;"><br> <button onclick="checkLogin()" style="width:100%;padding:12px;background:#3a73bd;color:#fff;border:none;border-radius:6px;cursor:pointer;">Entrar</button> <p id="loginError" style="color:red;margin-top:15px;display:none;">Usuario o contraseña incorrectos</p> </div> </div> `); function checkLogin(){ const u=document.getElementById("loginUser").value; const p=document.getElementById("loginPass").value; if(u===USERNAME && p===PASSWORD){ document.getElementById("loginOverlay").style.display="none"; }else{ document.getElementById("loginError").style.display="block"; } }</script>

<div class="container">
    <img alt="Logo de la empresa" class="logo-img rounded-full" crossorigin="anonymous" onerror="this.onerror=null;this.src='onerror.png';" src="speedylogo.png"/>
    <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">Generador de Notificaciones Interactivo</h1>
    <form class="space-y-6" id="generadorForm">
        <div class="section-container">
            <label for="tituloNotificacion">Título de la Notificación:</label>
            <textarea class="focus:ring-indigo-500 focus:border-red-500" id="tituloNotificacion" required=""></textarea>
        </div>
        <div class="section-container">
            <label for="tipoNotificacion">Tipo de Notificación:</label>
            <select class="focus:ring-indigo-500 focus:border-red-500" id="tipoNotificacion" required="">
                <option value="">Selecciona un tipo</option>
                <option value="Afectacion">[ Inicio de Afectación ]</option>
		<option value="ActualizacionAfectacion">[ Actualización de Afectación ]</option>
		<option value="Restablecimiento">[ Restablecimiento de Afectación ]</option>
                <option value="Intermitencia">[ Inicio de Intermitencia ]</option>
		<option value="ActualizacionIntermitencia">[ Actualización de Intermitencia ]</option>
		<option value="Restablecimiento">[ Restablecimiento Intermitencia ]</option>
		<option value="Ventana de Mantenimiento">[ Ventana de Mantenimiento Programada ]</option>
		<option value="InicioVM">[ Inicio de Ventana de Mantenimiento ]</option>
                <option value="Termino">[ Término de Ventana de Mantenimiento ]</option>
                <option value="Informativa">[ Informativa ]</option>
                <option value="Blanco">          </option>
            </select>
            <img alt="Imagen del tipo de notificación" class="dynamic-image" crossorigin="anonymous" id="imagenTipoNotificacion" src="" style="display: none;"/>
        </div>
        <div class="section-container">
            <label for="tipoSistema">Plataforma:</label>
            <select class="focus:ring-indigo-500 focus:border-red-500" id="tipoSistema" multiple="" required="" size="9">
                <option value="SMI">SMI</option>
                <option value="Mi Telcel">Mi Telcel</option>
                <option value="Mi Claro">Mi Claro</option>
                <option value="Apigee">Apigee</option>
                <option value="Contenedor">Contenedor</option>
                <option value="HUB">HUB</option>
                <option value="SMT">SMT</option>
                <option value="Claro Música">Claro Música</option>
                <option value="Claro Video">Claro Video</option>
                <option value="Netflix">Netflix</option>
                <option value="Disney">Disney</option>
                <option value="Amazon">Amazon</option>
                <option value="F1">F1</option>
                <option value="HBO">HBO</option>
                <option value="Fortinet">Fortinet</option>
                <option value="Infinitum">Infinitum</option>
                <option value="Telmex">Telmex</option>
                <option value="Internet">Internet</option>
                <option value="Active Directory">Active Directory</option>
                <option value="WiFi">WiFi</option>
                <option value="Unifi">Unifi</option>
                <option value="Splunk">Splunk</option>
                <option value="Kibana">Kibana</option>
                <option value="Dynatrace">Dynatrace</option>
                <option value="AppDynamics">AppDynamics</option>
                <option value="Mi Claro Chile">Mi Claro Chile</option>
                <option value="Mi Claro CENAM">Mi Claro CENAM</option>
                <option value="Mi Claro Perú">Mi Claro Perú</option>
                <option value="Chatbot">Chatbot</option> <option value="TelcelBot">TelcelBot</option>
            </select>
            <div class="platform-images-container" id="plataformasSeleccionadasContainer"></div>
        </div>
        <div class="section-container">
            <label for="descripcionCorta">¿En qué consiste?</label>
            <textarea class="focus:ring-indigo-500 focus:border-red-500" id="descripcionCorta" placeholder="Escribe una breve descripción del informe..."></textarea>
        </div>
        <div class="section-container">
            <label class="font-bold" for="consideracionesServicio">Consideraciones sobre el servicio:</label>
            <textarea class="focus:ring-indigo-500 focus:border-red-500" id="consideracionesServicio" placeholder="Detalles o notas adicionales sobre el servicio..."></textarea>
        </div>
        <div class="section-container">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="horaInicio">Hora de Inicio:</label>
                    <input class="focus:ring-indigo-500 focus:border-red-500" id="horaInicio" onchange="calcularAfectacionTotal()" type="datetime-local"/>
                </div>
                <div>
                    <label for="horaFin">Hora de Fin:</label>
                    <input class="focus:ring-indigo-500 focus:border-red-500" id="horaFin" onchange="calcularAfectacionTotal()" type="datetime-local"/>
                </div>
            </div>
            <div class="mt-4">
                <div class="flex items-center mb-2">
                    <input type="checkbox" id="sinAfectacionCheck" class="h-4 w-4 text-indigo-600 rounded mr-2" onclick="toggleAfectacionTotal()">
                    <label for="sinAfectacionCheck" class="text-sm text-gray-700">"Sin Afectación"</label>
                </div>
                <label>Afectación Total:</label>
                <p class="text-lg font-semibold text-gray-700" id="afectacionTotal">Sin Afectación</p>
            </div>
        </div>
        <div class="section-container">
            <label class="font-bold" for="equipoResponsableText">Equipo Responsable:</label>
            <div class="flex items-center gap-4 mb-4">
                <input class="flex-grow focus:ring-indigo-500 focus:border-red-500 mb-0" id="equipoResponsableText" placeholder="Introduce nuevo equipo" type="text"/>
                <button class="px-4 py-2 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded-md transition-colors duration-200" onclick="agregarEquipoResponsable()" type="button">Agregar</button>
            </div>
            <select class="focus:ring-indigo-500 focus:border-red-500" id="equipoResponsableSelect" multiple="" size="10">
                <option value="CITI">CITI</option>
                <option value="TELCEL">TELCEL</option>
                <option value="APIGEE">APIGEE</option>
                <option value="BACKEND">BACKEND</option>
                <option value="SPEEDYMOVIL">SPEEDYMOVIL</option>
                <option value="SSO">SSO</option>
                <option value="TANGO">TANGO</option>
                <option value="HUAWEI">HUAWEI</option>
                <option value="ISVA">ISVA</option>
		<option value="INFORMATICA">INFORMÁTICA TELCEL</option>
            </select>
        </div>
        <div class="section-container">
            <label class="font-bold" for="causaRaiz">Causa Raíz:</label>
            <textarea class="focus:ring-indigo-500 focus:border-red-500" id="causaRaiz" placeholder="Describe la causa raíz del incidente o situación..."></textarea>
        </div>
        <div class="section-container" id="serviciosAfectadosSection">
            <label class="font-bold" for="servicioAfectadoText">Servicios Afectados:</label>
            <div class="flex items-center gap-4 mb-4">
                <input class="flex-grow focus:ring-indigo-500 focus:border-red-500 mb-0" id="servicioAfectadoText" placeholder="Introduce nuevo servicio" type="text"/>
                <button class="px-4 py-2 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded-md transition-colors duration-200" onclick="agregarServicioAfectado()" type="button">Agregar</button>
            </div>
            <select class="focus:ring-indigo-500 focus:border-red-500" id="servicioAfectadoSelect" multiple="" size="5">
                <option value="ChargeAmount">ChargeAmount</option>
                <option value="ObtainProfile">ObtainProfile</option>
                <option value="executeOperation">executeOperation</option>
                <option value="Login">Login</option>
            </select>
            <div class="mt-4" id="serviciosPorcentajeContainer">
            </div>
            <label class="font-bold mt-4" for="afectacionUsuarioFinal">Afectación al usuario final:</label>
            <textarea class="focus:ring-indigo-500 focus:border-red-500" id="afectacionUsuarioFinal" placeholder="Describe la afectación al usuario final..."></textarea>
        </div>
        <div class="section-container" id="enviarCorreoSection">
            <label class="font-bold" for="correoAdicionalText">Enviar para Vo.Bo.:</label>
            <div class="flex items-center gap-4 mb-4">
                <input class="flex-grow focus:ring-indigo-500 focus:border-red-500 mb-0" id="correoAdicionalText" placeholder="Introduce nuevo correo" type="text"/>
                <button class="px-4 py-2 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded-md transition-colors duration-200" onclick="agregarCorreoAdicional()" type="button">Agregar</button>
            </div>
            <select class="focus:ring-indigo-500 focus:border-red-500" id="listasDistribucionSelect" multiple="" size="5">
                <option value="aldo.castillo@speedymovil.com">aldo.castillo@speedymovil.com</option>
		<option value="sonia.aragon@speedymovil.com">sonia.aragon@speedymovil.com</option>
		<option value="abraham.quintero@speedymovil.com">abraham.quintero@speedymovil.com</option>
		<option value="irene.lopez@speedymovil.com">irene.lopez@speedymovil.com</option>
		<option value="monica.delacruz@speedymovil.com">monica.delacruz@speedymovil.com</option>
		<option value="brandon.soto@speedymovil.com">brandon.soto@speedymovil.com</option>
		<option value="guadalupe.rodriguez@speedymovil.com">guadalupe.rodriguez@speedymovil.com</option>
		<option value="jose.rosas@speedymovil.com">jose.rosas@speedymovil.com</option>
                <option value="eduardo.sierra@speedymovil.com">eduardo.sierra@speedymovil.com</option>
            </select>
        </div>
	<div class="section-container" id="enviarExternosSection">
    	    <label class="font-bold" for="paisExternosSelect">Listas de Distribución:</label>
   	    <select id="paisExternosSelect" class="focus:ring-indigo-500 focus:border-red-500 mb-4">
   	        <option value="">-- Selecciona un país/plataforma --</option>
        	<option value="Mexico">México</option>
        	<option value="Argentina">Argentina</option>
        	<option value="Colombia">Colombia</option>
        	<option value="Brasil">Brasil</option>
        	<option value="Chile">Chile</option>
        	<option value="Peru">Perú</option>
        	</select>
            <div id="correosExternosContainer" class="bg-gray-50 border border-gray-300 rounded p-3 text-sm text-gray-700 mb-3" style="min-height:60px;">
                Selecciona un país/plataforma para ver los correos...
            </div>
            <button type="button" id="btnCopiarExternos" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-md">Copiar correos</button>
        </div>
        <div class="section-container">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Países Afectados:</h3>
            <div class="flex items-center mb-4">
                <input class="form-checkbox h-5 w-5 text-indigo-600 rounded mr-2" id="selectAllCountries" type="checkbox"/>
                <label class="text-gray-700 font-medium" for="selectAllCountries">Seleccionar Todos los Países</label>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="argentina.png" id="country_ar" name="paisesAfectados" type="checkbox" value="Argentina">
                    <img alt="Bandera de Argentina" crossorigin="anonymous" onerror="this.onerror=null;this.src='onerror.png';" src="argentina.png"/>
                    <label class="ml-2 text-gray-700" for="country_ar">Argentina</label>
                    </input></div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="brasil.png" id="country_br" name="paisesAfectados" type="checkbox" value="Brasil"/>
                    <img alt="Bandera de Brasil" crossorigin="anonymous" onerror="this.onerror=null;this.src='onerror.png';" src="brasil.png"/>
                    <label class="ml-2 text-gray-700" for="country_br">Brasil</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="chile.png" id="country_cl" name="paisesAfectados" type="checkbox" value="Chile"/>
                    <img alt="Bandera de Chile" crossorigin="anonymous" onerror="this.onerror=null;this.src='chile.png';" src="chile.png"/>
                    <label class="ml-2 text-gray-700" for="country_cl">Chile</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="colombia.png" id="country_co" name="paisesAfectados" type="checkbox" value="Colombia"/>
                    <img alt="Bandera de Colombia" crossorigin="anonymous" onerror="this.onerror=null;this.src='colombia.png';" src="colombia.png"/>
                    <label class="ml-2 text-gray-700" for="country_co">Colombia</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="costarica.png" id="country_cr" name="paisesAfectados" type="checkbox" value="Costa Rica"/>
                    <img alt="Bandera de Costa Rica" crossorigin="anonymous" onerror="this.onerror=null;this.src='costarica.png';" src="costarica.png"/>
                    <label class="ml-2 text-gray-700" for="country_cr">Costa Rica</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="ecuador.png" id="country_ec" name="paisesAfectados" type="checkbox" value="Ecuador"/>
                    <img alt="Bandera de Ecuador" crossorigin="anonymous" onerror="this.onerror=null;this.src='ecuador.png';" src="ecuador.png"/>
                    <label class="ml-2 text-gray-700" for="country_ec">Ecuador</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="elsalvador.png" id="country_sv" name="paisesAfectados" type="checkbox" value="El Salvador"/>
                    <img alt="Bandera de El Salvador" crossorigin="anonymous" onerror="this.onerror=null;this.src='elsalvador.png';" src="elsalvador.png"/>
                    <label class="ml-2 text-gray-700" for="country_sv">El Salvador</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="guatemala.png" id="country_gt" name="paisesAfectados" type="checkbox" value="Guatemala"/>
                    <img alt="Bandera de Guatemala" crossorigin="anonymous" onerror="this.onerror=null;this.src='guatemala.png';" src="guatemala.png"/>
                    <label class="ml-2 text-gray-700" for="country_gt">Guatemala</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="honduras.png" id="country_hn" name="paisesAfectados" type="checkbox" value="Honduras"/>
                    <img alt="Bandera de Honduras" crossorigin="anonymous" onerror="this.onerror=null;this.src='honduras.png';" src="honduras.png"/>
                    <label class="ml-2 text-gray-700" for="country_hn">Honduras</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="mexico.png" id="country_mx" name="paisesAfectados" type="checkbox" value="México"/>
                    <img alt="Bandera de México" crossorigin="anonymous" onerror="this.onerror=null;this.src='mexico.png';" src="mexico.png"/>
                    <label class="ml-2 text-gray-700" for="country_mx">México</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="nicaragua.png" id="country_ni" name="paisesAfectados" type="checkbox" value="Nicaragua"/>
                    <img alt="Bandera de Nicaragua" crossorigin="anonymous" onerror="this.onerror=null;this.src='nicaragua.png';" src="nicaragua.png"/>
                    <label class="ml-2 text-gray-700" for="country_ni">Nicaragua</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="panama.png" id="country_pa" name="paisesAfectados" type="checkbox" value="Panamá"/>
                    <img alt="Bandera de Panamá" crossorigin="anonymous" onerror="this.onerror=null;this.src='panama.png';" src="panama.png"/>
                    <label class="ml-2 text-gray-700" for="country_pa">Panamá</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="paraguay.png" id="country_py" name="paisesAfectados" type="checkbox" value="Paraguay"/>
                    <img alt="Bandera de Paraguay" crossorigin="anonymous" onerror="this.onerror=null;this.src='paraguay.png';" src="paraguay.png"/>
                    <label class="ml-2 text-gray-700" for="country_py">Paraguay</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="peru.png" id="country_pe" name="paisesAfectados" type="checkbox" value="Perú"/>
                    <img alt="Bandera de Perú" crossorigin="anonymous" onerror="this.onerror=null;this.src='peru.png';" src="peru.png"/>
                    <label class="ml-2 text-gray-700" for="country_pe">Perú</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="puertorico.png" id="country_pr" name="paisesAfectados" type="checkbox" value="Puerto Rico"/>
                    <img alt="Bandera de Puerto Rico" crossorigin="anonymous" onerror="this.onerror=null;this.src='puertorico.png';" src="puertorico.png"/>
                    <label class="ml-2 text-gray-700" for="country_pr">Puerto Rico</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="dominicana.png" id="country_do" name="paisesAfectados" type="checkbox" value="Dominicana"/>
                    <img alt="Bandera de Rep. Dominicana" crossorigin="anonymous" onerror="this.onerror=null;this.src='dominicana.png';" src="dominicana.png"/>
                    <label class="ml-2 text-gray-700" for="country_do">Dominicana</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="uruguay.png" id="country_uy" name="paisesAfectados" type="checkbox" value="Uruguay"/>
                    <img alt="Bandera de Uruguay" crossorigin="anonymous" onerror="this.onerror=null;this.src='uruguay.png';" src="uruguay.png"/>
                    <label class="ml-2 text-gray-700" for="country_uy">Uruguay</label>
                </div>
            </div>
        </div>
	<div class="flex justify-center items-center flex-wrap gap-4 mt-8 bg-purple-200 p-6 rounded-lg shadow-inner">
    		<button onclick="generarYMostrarResultado()" type="button">&nbsp;Generar Notificación y Previsualizar&nbsp;</button>==>
    		<button id="enviarCorreoBtn" onclick="generarHtmlParaCorreo()" type="button">&nbsp;Genera Correo para Vo.Bo.&nbsp;</button>/
    		<button id="btnExportImagen" onclick="generarImagen()" type="button" style="display:none;">&nbsp;Exportar como Imagen&nbsp;</button>/
    		<button id="btnExportPDF" onclick="generarPDF()" type="button" style="display:none;">&nbsp;Exportar como PDF&nbsp;</button>/
    		<button id="btnGuardarTXT" onclick="guardarComoTXT()" type="button" style="display:none;">&nbsp;Guardar como TXT&nbsp;</button>
            <button id="btnCargarTXT" type="button" onclick="cargarDesdeTXT()">&nbsp;Cargar desde TXT&nbsp;</button>
            <input type="file" id="inputCargarTXT" accept=".txt" style="display:none;" />

	</div>
    </form>
    <hr class="my-10 border-t-2 border-gray-200"/>
    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Previsualización de Notificación</h2>
    <div id="resultado">
        <p class="text-gray-600 text-center">La previsualizacion se mostrará aquí una vez generada.</p>
    </div>
</div>
<script>
    // Lista de correos por país
    const correosExternosPorPais = {
        "Mexico": ["mex@speedymovil.com", "sm-all@speedymovil.com"],
        "Argentina": ["arg@speedymovil.com"],
        "Colombia": ["col@speedymovil.com", "col-all@speedymovil.com"],
        "Brasil": ["bra@speedymovil.com"],
        "Chile": ["chi@speedymovil.com"],
        "Peru": ["per@speedymovil.com"]
    };

    /**
     * Función para calcular y mostrar la afectación total en Horas y Minutos.
     */
    function calcularAfectacionTotal() {
        if (document.getElementById('sinAfectacionCheck').checked) {
            document.getElementById('afectacionTotal').textContent = 'Sin Afectación';
            return;
        }

        const horaInicioInput = document.getElementById('horaInicio').value;
        const horaFinInput = document.getElementById('horaFin').value;
        const afectacionTotalElement = document.getElementById('afectacionTotal');

        if (horaInicioInput && !horaFinInput) {
            afectacionTotalElement.textContent = 'En Curso';
            return;
        }

        if (!horaInicioInput || !horaFinInput) {
            afectacionTotalElement.textContent = 'Sin Afectación';
            return;
        }

        const fechaInicio = new Date(horaInicioInput);
        const fechaFin = new Date(horaFinInput);

        if (isNaN(fechaInicio.getTime()) || isNaN(fechaFin.getTime())) {
            afectacionTotalElement.textContent = 'Fechas inválidas';
            return;
        }
        if (fechaFin < fechaInicio) {
            afectacionTotalElement.textContent = 'La hora de fin no puede ser anterior a la de inicio';
            return;
        }

        const diferenciaMilisegundos = fechaFin.getTime() - fechaInicio.getTime();
        
        if (diferenciaMilisegundos === 0) {
            afectacionTotalElement.textContent = 'Sin Afectación';
            return;
        }

        const totalMinutos = Math.floor(diferenciaMilisegundos / (1000 * 60));
        const horas = Math.floor(totalMinutos / 60);
        const minutos = totalMinutos % 60;

        let resultadoString = '';
        if (horas > 0) {
            resultadoString += `${horas} ${horas === 1 ? 'hora' : 'horas'}`;
        }
        if (minutos > 0) {
            if (resultadoString.length > 0) {
                resultadoString += ' - ';
            }
            resultadoString += `${minutos} ${minutos === 1 ? 'minuto' : 'minutos'}`;
        }
        
        afectacionTotalElement.textContent = resultadoString;
    }

    /**
     * Function to toggle "Sin Afectación" text.
     */
    function toggleAfectacionTotal() {
        const sinAfectacionCheck = document.getElementById('sinAfectacionCheck');
        const horaInicioInput = document.getElementById('horaInicio');
        const horaFinInput = document.getElementById('horaFin');

        if (sinAfectacionCheck.checked) {
            document.getElementById('afectacionTotal').textContent = 'Sin Afectación';
            horaInicioInput.disabled = true;
            horaFinInput.disabled = true;
        } else {
            horaInicioInput.disabled = false;
            horaFinInput.disabled = false;
            calcularAfectacionTotal();
        }
    }

    /**
     * Function to add a new option to the "Equipo Responsable" dropdown menu.
     */
    function agregarEquipoResponsable() {
        const equipoResponsableTextInput = document.getElementById('equipoResponsableText');
        const equipoResponsableSelect = document.getElementById('equipoResponsableSelect');
        const nuevoEquipo = equipoResponsableTextInput.value.trim();

        if (nuevoEquipo) {
            let exists = false;
            for (let i = 0; i < equipoResponsableSelect.options.length; i++) {
                if (equipoResponsableSelect.options[i].value === nuevoEquipo) {
                    exists = true;
                    break;
                }
            }

            if (!exists) {
                const newOption = document.createElement('option');
                newOption.value = nuevoEquipo;
                newOption.textContent = nuevoEquipo;
                equipoResponsableSelect.appendChild(newOption);
            }
            equipoResponsableTextInput.value = '';
        }
    }

    /**
     * Function to add a new option to the "Servicios Afectados" dropdown menu.
     */
    function agregarServicioAfectado() {
        const servicioAfectadoTextInput = document.getElementById('servicioAfectadoText');
        const servicioAfectadoSelect = document.getElementById('servicioAfectadoSelect');
        const nuevoServicio = servicioAfectadoTextInput.value.trim();

        if (nuevoServicio) {
            let exists = false;
            for (let i = 0; i < servicioAfectadoSelect.options.length; i++) {
                if (servicioAfectadoSelect.options[i].value === nuevoServicio) {
                    exists = true;
                    break;
                }
            }

            if (!exists) {
                const newOption = document.createElement('option');
                newOption.value = nuevoServicio;
                newOption.textContent = nuevoServicio;
                servicioAfectadoSelect.appendChild(newOption);
                handleServicioAfectadoChange();
            }
            servicioAfectadoTextInput.value = '';
        }
    }

    /**
     * Function to add a new email address to the "Vo.Bo." dropdown menu.
     */
    function agregarCorreoAdicional() {
        const correoAdicionalTextInput = document.getElementById('correoAdicionalText');
        const listasDistribucionSelect = document.getElementById('listasDistribucionSelect');
        const nuevoCorreo = correoAdicionalTextInput.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        if (nuevoCorreo && emailRegex.test(nuevoCorreo)) {
            let exists = false;
            for (let i = 0; i < listasDistribucionSelect.options.length; i++) {
                if (listasDistribucionSelect.options[i].value === nuevoCorreo) {
                    exists = true;
                    break;
                }
            }

            if (!exists) {
                const newOption = document.createElement('option');
                newOption.value = nuevoCorreo;
                newOption.textContent = nuevoCorreo;
                listasDistribucionSelect.appendChild(newOption);
            }
            correoAdicionalTextInput.value = '';
        } else if (nuevoCorreo) {
            alert('Por favor, introduce una dirección de correo electrónico válida.');
        }
    }


    /**
     * Function to get all selected options from a multi-select dropdown.
     */
    function getSelectedOptions(selectElement) {
        const selected = [];
        for (let i = 0; i < selectElement.options.length; i++) {
            if (selectElement.options[i].selected) {
                selected.push(selectElement.options[i].value);
            }
        }
        return selected;
    }

    /**
     * Dynamically creates/removes percentage input fields for each selected service.
     */
    function handleServicioAfectadoChange() {
        const servicioAfectadoSelect = document.getElementById('servicioAfectadoSelect');
        const serviciosPorcentajeContainer = document.getElementById('serviciosPorcentajeContainer');
        serviciosPorcentajeContainer.innerHTML = '';
        const selectedServices = getSelectedOptions(servicioAfectadoSelect);

        selectedServices.forEach(service => {
            const serviceItemDiv = document.createElement('div');
            serviceItemDiv.classList.add('servicio-porcentaje-item');

            const serviceNameSpan = document.createElement('span');
            serviceNameSpan.textContent = service;
            serviceNameSpan.classList.add('font-medium', 'text-gray-700');

            const percentageInput = document.createElement('input');
            percentageInput.type = 'number';
            percentageInput.min = "0";
            percentageInput.max = "100";
            percentageInput.placeholder = '%';
            percentageInput.classList.add('focus:ring-indigo-500', 'focus:border-red-500');
            percentageInput.dataset.serviceName = service;

            serviceItemDiv.appendChild(serviceNameSpan);
            serviceItemDiv.appendChild(percentageInput);
            serviciosPorcentajeContainer.appendChild(serviceItemDiv);
        });
    }


    /**
     * Main function to generate the report and display it in the preview section.
     */
    function generarYMostrarResultado() {
        const tituloNotificacion = document.getElementById('tituloNotificacion').value.trim();
        const tituloNotificacionConSaltosDeLinea = tituloNotificacion.replace(/\n/g, '<br>');	
        const tipoNotificacionSelect = document.getElementById('tipoNotificacion');
        const tipoNotificacion = tipoNotificacionSelect.value;
        const tipoNotificacionTexto = tipoNotificacionSelect.options[tipoNotificacionSelect.selectedIndex].text;
        const tipoSistemaSelect = document.getElementById('tipoSistema');
        const plataformasSeleccionadas = getSelectedOptions(tipoSistemaSelect);
        const descripcionCorta = document.getElementById('descripcionCorta').value.trim();
        const consideracionesServicio = document.getElementById('consideracionesServicio').value.trim();
        const horaInicio = document.getElementById('horaInicio').value;
        const horaFin = document.getElementById('horaFin').value;
        const afectacionTotal = document.getElementById('afectacionTotal').textContent;
        const equipoResponsableSelectElement = document.getElementById('equipoResponsableSelect');
        const equiposResponsablesSeleccionados = getSelectedOptions(equipoResponsableSelectElement);
        const causaRaiz = document.getElementById('causaRaiz').value.trim();
        const afectacionUsuarioFinal = document.getElementById('afectacionUsuarioFinal').value.trim();

        const serviciosConPorcentaje = [];
        document.querySelectorAll('#serviciosPorcentajeContainer .servicio-porcentaje-item input[type="number"]').forEach(input => {
            const serviceName = input.dataset.serviceName;
            const percentage = input.value.trim();
            if (serviceName) {
                serviciosConPorcentaje.push(`${serviceName}${percentage ? ` (${percentage}%)` : ''}`);
            }
        });

        const resultadoDiv = document.getElementById('resultado');
        const enviarCorreoBtn = document.getElementById('enviarCorreoBtn');
        const paisesAfectadosCheckboxes = document.querySelectorAll('input[name="paisesAfectados"]:checked');

        const paisesAfectadosInfo = Array.from(paisesAfectadosCheckboxes).map(cb => ({
            name: cb.value,
            img: cb.dataset.img
        }));

        const plataformaImageMap = {
            "SMI": "smi.png", "Mi Telcel": "mitelcel.png", "Mi Claro": "miclaro.png",
            "Apigee": "apigee.png", "Contenedor": "contenedor.png", "HUB": "hub.png",
            "SMT": "smt.png", "Claro Música": "claromusica.png", "Claro Video": "clarovideo.png",
            "Netflix": "netflix.png", "Disney": "disney.png", "Amazon": "amazon.png",
            "F1": "f1.png", "HBO": "hbo.png", "Fortinet": "fortinet.png",
            "Infinitum": "infinitum.png", "Telmex": "telmex.png", "Internet": "internet.png",
            "Active Directory": "AD.png", "WiFi": "wifi.png", "Unifi": "unifi.png",
            "Splunk": "splunk.png", "Kibana": "kibana.png", "Dynatrace": "dynatrace.png", 
            "AppDynamics": "appdynamics.png", "Mi Claro Chile": "miclarochile.png", 
            "Mi Claro CENAM": "miclarocenam.png", "Mi Claro Perú": "miclaroperu.png",
            "Chatbot": "chatbot.png", "TelcelBot": "telcelbot.png" // ADDED
        };

        const tipoNotificacionImageMap = {
            "InicioVM": "engrane2.png", "Actualizacion": "engrane2.png", "Termino": "ok.png",
            "Restablecimiento": "ok.png", "Intermitencia": "warning.png", "Afectacion": "dead.png",
            "Ventana de Mantenimiento": "vm.png", "ActualizacionIntermitencia": "engrane3.png",
            "ActualizacionAfectacion": "engrane.png","Informativa": "informativa.png" // ADDED
        };

        let tipoNotificacionImageHtml = '';
        if (tipoNotificacion && tipoNotificacionImageMap[tipoNotificacion]) {
            tipoNotificacionImageHtml = `<img src="${tipoNotificacionImageMap[tipoNotificacion]}" alt="${tipoNotificacion}" class="type-notification-image" onerror="this.onerror=null;this.src='onerror.png';" crossorigin="anonymous">`;
        }

        let plataformaImagesHtml = '';
        if (plataformasSeleccionadas.length > 0) {
            plataformaImagesHtml = `<div class="platform-images-container">${plataformasSeleccionadas.map(platform => 
                plataformaImageMap[platform] ? `<div class="platform-item">
                    <img src="${plataformaImageMap[platform]}" alt="${platform}" class="dynamic-image" onerror="this.onerror=null;this.src='onerror.png';" crossorigin="anonymous">
                    <span>${platform}</span>
                </div>` : ''
            ).join('')}</div>`;
        }

        let paisesAfectadosImagesHtml = '';
        if (paisesAfectadosInfo.length > 0) {
            paisesAfectadosImagesHtml = `<div class="flag-images-container">${paisesAfectadosInfo.map(country => `
                <div class="flag-item">
                    <img src="${country.img}" alt="Bandera de ${country.name}" title="${country.name}" onerror="this.onerror=null;this.src='onerror.png';" crossorigin="anonymous">
                    <span>${country.name}</span>
                </div>`).join('')}
            </div>`;
        }

        let plantillaHTML = `
            <div class="preview-grid">
                <div class="preview-grid-cell" style="text-align: left;">
                    <div><img src="speedylogo.png" alt="Logo Speedy" style="height:90px;" onerror="this.onerror=null;this.src='onerror.png';" crossorigin="anonymous"></div>
                </div>
                <div class="preview-grid-cell">${tipoNotificacionImageHtml}</div>
                <div class="preview-grid-cell spanning-row">
                    <span class="tipo-notificacion-texto">${tipoNotificacionTexto}</span>
                    <h4>${tituloNotificacionConSaltosDeLinea}</h4>
                </div>
                <div class="preview-grid-cell spanning-row">
                    <strong class="preview-section-title">Plataforma(s):</strong>
                    ${plataformaImagesHtml}
                </div>
                <div class="preview-grid-cell spanning-row content-only">
                    <p class="description-text"><strong>¿En qué consiste?:</strong> ${descripcionCorta || ''}</p>
                </div>
                <div class="preview-grid-cell spanning-row content-only">
                    <p class="considerations-text"><strong>Consideraciones sobre el servicio:</strong> ${consideracionesServicio || ' '}</p>
                </div>
                <div class="preview-grid-cell orange-bordered-cell">
                    <strong class="preview-section-title">Horario:</strong>
                    <div class="preview-section-content">
                        <p><strong>Inicio:</strong> ${horaInicio ? new Date(horaInicio).toLocaleString() : '--'}</p>
                        <p><strong>Fin:</strong> ${horaFin ? new Date(horaFin).toLocaleString() : '--'}</p>
                        <p><strong>Afectación Total:</strong> ${afectacionTotal}</p>
                    </div>
                </div>
                <div class="preview-grid-cell row-span-2" style="border: 5px solid #3b82f6; border-radius: 8px; padding: 15px;">
                    <strong class="preview-section-title">Servicio(s) Afectado(s):</strong>
                    <div class="preview-section-content"><p>${serviciosConPorcentaje.length > 0 ? serviciosConPorcentaje.join('<br>') : 'Por Definir'}</p></div>
                    <strong class="preview-section-title">Afectación al usuario final:</strong>
                    <div class="preview-section-content"><p>${afectacionUsuarioFinal || 'Por Definir'}</p></div>
                </div>
                <div class="preview-grid-cell" style="border: 5px solid #3b82f6; border-radius: 8px; padding: 15px;">
                    <strong class="preview-section-title">Responsable(s) y Causa Raíz:</strong>
                    <div class="preview-section-content">
                        <p><strong>Equipo(s) Responsable(s):</strong> ${equiposResponsablesSeleccionados.length > 0 ? equiposResponsablesSeleccionados.join(', ') : 'Por Definir'}</p>
                        <p><strong>Causa Raíz:</strong> ${causaRaiz || 'Por Definir'}</p>
                    </div>
                </div>
                <div class="preview-grid-cell spanning-row orange-bordered-cell">
                    <strong class="preview-section-title">País(es) Afectado(s):</strong>
                    ${paisesAfectadosInfo.length > 0 ? paisesAfectadosImagesHtml : '<p>Por Definir</p>'}
                </div>
            </div>`;
            
        // ---> CORRECCIÓN DEL TEXTO LEGAL <---
        plantillaHTML += `
            <div class="mt-8 pt-4 border-t border-gray-200 text-xs text-gray-500 leading-relaxed" >
                <p>Si tienen alguna duda, favor de contactar a <a href="mailto:soporte@speedymovil.com" class="text-blue-600 hover:underline">soporte@speedymovil.com</a></p>
                <p>&nbsp;</p>
                <p>Saludos cordiales.</p>
                <p>&nbsp;</p>
                <p>&nbsp;</p>
                <p>Gerencia de Soporte</p>
                <p>&nbsp;</p>
                <p>Este mensaje es exclusivamente para el uso de la persona o entidad a quien está dirigido; contiene información estrictamente confidencial y legalmente protegida, cuya divulgación es sancionada por la ley. Si el lector de este mensaje no es a quien está dirigido, ni se trata del empleado o agente responsable de esta información, se le notifica por medio del presente, que su reproducción y distribución, está estrictamente prohibida. Si Usted recibió este comunicado por error, favor de notificarlo inmediatamente al remitente y destruir el mensaje. Todas las opiniones contenidas en este mail son propias del autor del mensaje y no necesariamente coinciden con las de América Móvil, S.A. de C.V. o alguna de sus empresas controladas, controladoras, afiliadas y subsidiarias.</p>
            </div>`;

        resultadoDiv.innerHTML = plantillaHTML;
        enviarCorreoBtn.style.display = 'inline-block';
        document.getElementById('btnExportImagen').style.display = 'inline-block';
        document.getElementById('btnExportPDF').style.display = 'inline-block';
        document.getElementById('btnGuardarTXT').style.display = 'inline-block';
    }
    
	function generarHtmlParaCorreo() {
   	 const titulo = document.getElementById('tituloNotificacion').value.trim();
    	const tipoNotifSelect = document.getElementById('tipoNotificacion');
    	const tipoNotifTexto = tipoNotifSelect.options[tipoNotifSelect.selectedIndex].text;
    	const plataformas = getSelectedOptions(document.getElementById('tipoSistema'));
    	const servicios = getSelectedOptions(document.getElementById('servicioAfectadoSelect'));
    	const correosAdicionales = getSelectedOptions(document.getElementById('listasDistribucionSelect'));

    	if (!titulo || plataformas.length === 0 || !tipoNotifTexto) {
       	 alert('Función no disponible sin previsualización completada');
       	 return;
    }

    let tipoNotificacionAsunto = tipoNotifTexto.replace(/\[|\]/g, '').trim();

    // Revisa si el texto contiene alguna de las palabras clave
    if (tipoNotificacionAsunto.includes('Inicio') || tipoNotificacionAsunto.includes('Actualización') || tipoNotificacionAsunto.includes('Restablecimiento')) {
        tipoNotificacionAsunto = tipoNotificacionAsunto.split(' ')[0];
    }
    
    const subject = `[${titulo}] - [${tipoNotificacionAsunto}] - [${plataformas.join(', ')}] - ${servicios.join(', ') || 'Por Definir'}`;
    const todosLosDestinatarios = new Set(['soporte@speedymovil.com', ...correosAdicionales]);
    const destinatariosString = Array.from(todosLosDestinatarios).join(',');
    window.location.href = `mailto:${destinatariosString}?subject=${encodeURIComponent(subject)}`;
    }

    function handleTipoNotificacionChange() {
        const tipoNotificacionSelect = document.getElementById('tipoNotificacion');
        const imagenTipoNotificacion = document.getElementById('imagenTipoNotificacion');
        const selectedValue = tipoNotificacionSelect.value;
        const imageMap = {
            "InicioVM": "engrane2.png", "Actualizacion": "engrane2.png", "Termino": "ok.png",
            "Restablecimiento": "ok.png", "Intermitencia": "warning.png", "Afectacion": "dead.png",
            "Ventana de Mantenimiento": "vm.png", "ActualizacionIntermitencia": "engrane3.png",
            "ActualizacionAfectacion": "engrane.png","Informativa": "informativa.png" // ADDED
        };
        if (selectedValue && imageMap[selectedValue]) {
            imagenTipoNotificacion.src = imageMap[selectedValue];
            imagenTipoNotificacion.style.display = 'block';
        } else {
            imagenTipoNotificacion.style.display = 'none';
            imagenTipoNotificacion.src = '';
        }
    }

    function handleTipoSistemaChange() {
        const tipoSistemaSelect = document.getElementById('tipoSistema');
        const plataformasSeleccionadasContainer = document.getElementById('plataformasSeleccionadasContainer');
        const selectedValues = getSelectedOptions(tipoSistemaSelect);
        plataformasSeleccionadasContainer.innerHTML = '';
        const imageMap = {
            "SMI": "smi.png", "Mi Telcel": "mitelcel.png", "Mi Claro": "miclaro.png",
            "Apigee": "apigee.png", "Contenedor": "contenedor.png", "HUB": "hub.png",
            "SMT": "smt.png", "Claro Música": "claromusica.png", "Claro Video": "clarovideo.png",
            "Netflix": "netflix.png", "Disney": "disney.png", "Amazon": "amazon.png",
            "F1": "f1.png", "HBO": "hbo.png", "Fortinet": "fortinet.png",
            "Infinitum": "infinitum.png", "Telmex": "telmex.png", "Internet": "internet.png",
            "Active Directory": "AD.png", "WiFi": "wifi.png", "Unifi": "unifi.png",
            "Splunk": "splunk.png", "Kibana": "kibana.png", "Dynatrace": "dynatrace.png", 
            "AppDynamics": "appdynamics.png", "Mi Claro Chile": "miclarochile.png", 
            "Mi Claro CENAM": "miclarocenam.png", "Mi Claro Perú": "miclaroperu.png",
            "Chatbot": "chatbot.png", "TelcelBot": "telcelbot.png" // ADDED
        };
        selectedValues.forEach(platform => {
            if (imageMap[platform]) {
                const platformItemDiv = document.createElement('div');
                platformItemDiv.classList.add('platform-item');
                const img = document.createElement('img');
                img.src = imageMap[platform];
                img.alt = platform;
                img.classList.add('dynamic-image');
                img.onerror = function() { this.onerror=null; this.src='onerror.png'; };
                platformItemDiv.appendChild(img);
                const span = document.createElement('span');
                span.textContent = platform;
                platformItemDiv.appendChild(span);
                plataformasSeleccionadasContainer.appendChild(platformItemDiv);
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('enviarCorreoBtn').style.display = 'none';
        calcularAfectacionTotal();
        document.getElementById('servicioAfectadoSelect').addEventListener('change', handleServicioAfectadoChange);
        handleServicioAfectadoChange();
        document.getElementById('tipoNotificacion').addEventListener('change', handleTipoNotificacionChange);
        document.getElementById('tipoSistema').addEventListener('change', handleTipoSistemaChange);
        handleTipoSistemaChange();
        document.getElementById('selectAllCountries').addEventListener('change', handleSelectAllCountries);
        document.getElementById('sinAfectacionCheck').addEventListener('change', toggleAfectacionTotal);

        // Event listeners para la sección de externos
        document.getElementById('paisExternosSelect').addEventListener('change', function() {
            const pais = this.value;
            const contenedor = document.getElementById('correosExternosContainer');
            if (pais && correosExternosPorPais[pais]) {
                contenedor.innerHTML = correosExternosPorPais[pais].join('<br>');
            } else {
                contenedor.innerHTML = 'Selecciona un país/plataforma para ver los correos...';
            }
        });

        document.getElementById('btnCopiarExternos').addEventListener('click', function() {
            const pais = document.getElementById('paisExternosSelect').value;
            if (pais && correosExternosPorPais[pais]) {
                const texto = correosExternosPorPais[pais].join(', ');
                navigator.clipboard.writeText(texto)
                    .then(() => alert('Correos copiados al portapapeles: ' + texto))
                    .catch(() => alert('No se pudo copiar. Por favor, copia manualmente.'));
            } else {
                alert('Selecciona un país/plataforma válido para copiar sus correos');
            }
        });
    });

    function handleSelectAllCountries() {
        const selectAllCheckbox = document.getElementById('selectAllCountries');
        document.querySelectorAll('input[name="paisesAfectados"]').forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
    }

    function construirNombreArchivo() {
        const titulo = document.getElementById('tituloNotificacion').value.trim() || 'Notificacion';
        const tipoNotifSelect = document.getElementById('tipoNotificacion');
        const tipoNotifTexto = tipoNotifSelect.options[tipoNotifSelect.selectedIndex].text.replace(/\[|\]|\s/g, '') || 'Tipo';
        const plataformas = getSelectedOptions(document.getElementById('tipoSistema')).join(',') || 'Plataforma';
        const now = new Date();
        const timestamp = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}h${now.getMinutes().toString().padStart(2, '0')}m`;
        let baseName = `${titulo}-${tipoNotifTexto}-${plataformas}_${timestamp}`;
        return baseName.replace(/\s/g, '_').replace(/[\/\\?%*:,"|<>]/g, '-');
    }

    function generarImagen() {
        const resultado = document.getElementById('resultado');
        if (!resultado || resultado.innerText.includes("La previsualizacion se mostrará aquí")) {
            alert("Primero debes generar una notificación.");
            return;
        }
        const nombreArchivo = construirNombreArchivo();
        const originalMaxWidth = resultado.style.maxWidth;
        const originalWidth = resultado.style.width;
        resultado.style.border = 'none';
        resultado.style.maxWidth = '850px';
        resultado.style.width = '850px';

        html2canvas(resultado, { scale: 2, useCORS: true, allowTaint: false })
        .then(canvas => {
            const link = document.createElement('a');
            link.download = `${nombreArchivo}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }).catch(err => {
            alert("Error al generar la imagen: " + err.message);
            console.error(err);
        }).finally(() => {
            resultado.style.maxWidth = originalMaxWidth;
            resultado.style.width = originalWidth;
        });
    }

    function generarPDF() {
        const resultado = document.getElementById('resultado');
        if (!resultado || resultado.innerText.includes("La previsualizacion se mostrará aquí")) {
            alert("Primero debes generar una notificación.");
            return;
        }
        const nombreArchivo = construirNombreArchivo();
        const originalBorder = resultado.style.border;
        const originalMaxWidth = resultado.style.maxWidth;
        const originalWidth = resultado.style.width;
        
        resultado.style.border = 'none';
        resultado.style.maxWidth = '850px';
        resultado.style.width = '850px';

        html2canvas(resultado, { useCORS: true, allowTaint: false, scale: 2 })
        .then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const ratio = Math.min(pageWidth / canvas.width, pageHeight / canvas.height);
            const finalImgWidth = canvas.width * ratio;
            const finalImgHeight = canvas.height * ratio;
            const xPos = (pageWidth - finalImgWidth) / 2;

            pdf.addImage(imgData, 'PNG', xPos, 0, finalImgWidth, finalImgHeight);
            pdf.save(`${nombreArchivo}.pdf`);
        }).catch(err => {
            alert("Error al generar el PDF: " + err.message);
            console.error(err);
        }).finally(() => {
            resultado.style.border = originalBorder;
            resultado.style.maxWidth = originalMaxWidth;
            resultado.style.width = originalWidth;
        });
    }

    /**
     * Función para guardar la información de la notificación en un archivo .txt.
     */
    function guardarComoTXT() {
        const resultado = document.getElementById('resultado');
        if (!resultado || resultado.innerText.includes("La previsualizacion se mostrará aquí")) {
            alert("Primero debes generar una notificación para poder guardarla.");
            return;
        }

        // 1. Recolectar toda la información de los campos (similar a la función de previsualización)
        const tituloNotificacion = document.getElementById('tituloNotificacion').value.trim();
        const tipoNotificacionSelect = document.getElementById('tipoNotificacion');
        const tipoNotificacionTexto = tipoNotificacionSelect.options[tipoNotificacionSelect.selectedIndex].text;
        const plataformasSeleccionadas = getSelectedOptions(document.getElementById('tipoSistema'));
        const descripcionCorta = document.getElementById('descripcionCorta').value.trim();
        const consideracionesServicio = document.getElementById('consideracionesServicio').value.trim();
        const horaInicio = document.getElementById('horaInicio').value;
        const horaFin = document.getElementById('horaFin').value;
        const afectacionTotal = document.getElementById('afectacionTotal').textContent;
        const equiposResponsablesSeleccionados = getSelectedOptions(document.getElementById('equipoResponsableSelect'));
        const causaRaiz = document.getElementById('causaRaiz').value.trim();
        const afectacionUsuarioFinal = document.getElementById('afectacionUsuarioFinal').value.trim();

        const serviciosConPorcentaje = [];
        document.querySelectorAll('#serviciosPorcentajeContainer .servicio-porcentaje-item input[type="number"]').forEach(input => {
            const serviceName = input.dataset.serviceName;
            const percentage = input.value.trim();
            if (serviceName) {
                serviciosConPorcentaje.push(`${serviceName}${percentage ? ` (${percentage}%)` : ''}`);
            }
        });

        const paisesAfectadosCheckboxes = document.querySelectorAll('input[name="paisesAfectados"]:checked');
        const paisesAfectadosNombres = Array.from(paisesAfectadosCheckboxes).map(cb => cb.value);

        // 2. Formatear la información como texto plano
        let contenidoTXT = `
========================================
RESUMEN DE LA NOTIFICACIÓN
========================================

Título: ${tituloNotificacion || 'No especificado'}
Tipo de Notificación: ${tipoNotificacionTexto || 'No especificado'}

----------------------------------------
DETALLES
----------------------------------------

Plataforma(s): ${plataformasSeleccionadas.join(', ') || 'No especificadas'}
¿En qué consiste?: ${descripcionCorta || 'No especificado'}
Consideraciones sobre el servicio: ${consideracionesServicio || 'Ninguna'}

----------------------------------------
CRONOLOGÍA Y AFECTACIÓN
----------------------------------------

Hora de Inicio: ${horaInicio ? new Date(horaInicio).toLocaleString() : '--'}
Hora de Fin: ${horaFin ? new Date(horaFin).toLocaleString() : '--'}
Afectación Total: ${afectacionTotal || 'No especificada'}

----------------------------------------
ANÁLISIS Y RESPONSABLES
----------------------------------------

Equipo(s) Responsable(s): ${equiposResponsablesSeleccionados.join(', ') || 'Por Definir'}
Causa Raíz: ${causaRaiz || 'Por Definir'}

----------------------------------------
IMPACTO
----------------------------------------

Servicio(s) Afectado(s): ${serviciosConPorcentaje.join(', ') || 'Por Definir'}
Afectación al usuario final: ${afectacionUsuarioFinal || 'Por Definir'}
País(es) Afectado(s): ${paisesAfectadosNombres.join(', ') || 'Por Definir'}

========================================
Generado el ${new Date().toLocaleString()}
========================================
`;

        // 3. Crear el nombre del archivo usando la función existente
        const nombreArchivo = construirNombreArchivo() + '.txt';

        // 4. Crear un Blob y un enlace para descargar el archivo
        const blob = new Blob([contenidoTXT.trim()], { type: 'text/plain;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = nombreArchivo;

        // Simular clic para iniciar la descarga
        document.body.appendChild(link);
        link.click();

        // Limpiar
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
    }
</script>

<script>
// ==============================
// CARGAR DATOS DESDE TXT (CORREGIDO)
// ==============================
window.cargarDesdeTXT = function() {
    var fileInput = document.getElementById('inputCargarTXT');
    if (!fileInput) {
        alert('No se encontró el input para cargar TXT.');
        return;
    }
    fileInput.click();
};

(function attachTXTHandler(){
    function onChangeHandler(event) {
        const file = event.target.files && event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const contenido = e.target.result || '';

            const getValue = (label) => {
                const regex = new RegExp("^" + label + ": (.*)$", "m");
                const match = contenido.match(regex);
                return match ? match[1].trim() : "";
            };

            let v;

            // Título
            v = getValue("Título");
            if (v !== "") { document.getElementById('tituloNotificacion').value = v; }

            // Tipo de Notificación
            v = getValue("Tipo de Notificación").replace(/\[|\]/g,"").trim();
            if (v) {
                let sel = document.getElementById('tipoNotificacion');
                Array.from(sel.options).forEach(opt => {
                    let t = (opt.text||"").replace(/\[|\]/g,"").trim();
                    if (t === v) opt.selected = true;
                });
            }

            // Plataforma(s)
            v = getValue("Plataforma\\(s\\)");
            if (v) {
                let list = v.split(",").map(x=>x.trim()).filter(Boolean);
                let selPlat = document.getElementById('tipoSistema');
                Array.from(selPlat.options).forEach(opt => {
                    opt.selected = list.includes(opt.value);
                });
            }

            // ¿En qué consiste?
            v = getValue("¿En qué consiste\\?");
            if (v !== "") { document.getElementById('descripcionCorta').value = v; }

            // Consideraciones
            v = getValue("Consideraciones sobre el servicio");
            if (v !== "") { document.getElementById('consideracionesServicio').value = v; }

            // Hora de Inicio / Fin
            function parseFecha(texto) {
                if (!texto || texto === "--") return "";
                var partes = texto.split(",");
                if (partes.length < 2) return "";
                var f = partes[0].trim().split("/");
                if (f.length !== 3) return "";
                var d = f[0], m = f[1], y = f[2];
                var hora = partes[1].trim();
                var hhmm = hora.slice(0,5);
                return y + "-" + m.padStart(2,"0") + "-" + d.padStart(2,"0") + "T" + hhmm;
            }
            v = getValue("Hora de Inicio"); if (v) { document.getElementById('horaInicio').value = parseFecha(v); }
            v = getValue("Hora de Fin"); if (v) { document.getElementById('horaFin').value = parseFecha(v); }
            
            // Equipo(s) Responsable(s)
            v = getValue("Equipo\\(s\\) Responsable\\(s\\)");
            if (v) {
                let list = v.split(",").map(x => x.trim()).filter(Boolean);
                let selEq = document.getElementById('equipoResponsableSelect');
                let existingOptions = Array.from(selEq.options).map(opt => opt.value);
                list.forEach(item => {
                    if (!existingOptions.includes(item)) {
                        const newOption = document.createElement('option');
                        newOption.value = item;
                        newOption.textContent = item;
                        selEq.appendChild(newOption);
                    }
                });
                Array.from(selEq.options).forEach(opt => {
                    opt.selected = list.includes(opt.value);
                });
            }

            // Servicio(s) Afectado(s)
            v = getValue("Servicio\\(s\\) Afectado\\(s\\)");
            if (v) {
                const servicesWithPercentages = v.split(',').map(item => {
                    const match = item.trim().match(/^(.*?)(?:\s\((\d+)%\))?$/);
                    return match ? { name: match[1], percentage: match[2] || null } : null;
                }).filter(Boolean);

                const serviceNames = servicesWithPercentages.map(s => s.name);
                const selSrv = document.getElementById('servicioAfectadoSelect');
                let existingServices = Array.from(selSrv.options).map(opt => opt.value);
                
                serviceNames.forEach(name => {
                    if (!existingServices.includes(name)) {
                        const newOption = document.createElement('option');
                        newOption.value = name;
                        newOption.textContent = name;
                        selSrv.appendChild(newOption);
                    }
                });
                
                Array.from(selSrv.options).forEach(opt => {
                    opt.selected = serviceNames.includes(opt.value);
                });
                
                handleServicioAfectadoChange();
                
                servicesWithPercentages.forEach(service => {
                    if (service.percentage !== null) {
                        const input = document.querySelector(`#serviciosPorcentajeContainer input[data-service-name="${service.name}"]`);
                        if (input) input.value = service.percentage;
                    }
                });
            }

            // Causa Raíz
            v = getValue("Causa Raíz");
            if (v !== "") { document.getElementById('causaRaiz').value = v; }

            // Afectación usuario final
            v = getValue("Afectación al usuario final");
            if (v !== "") { document.getElementById('afectacionUsuarioFinal').value = v; }

            // País(es) Afectados
            v = getValue("País\\(es\\) Afectado\\(s\\)");
            if (v) {
                let list = v.split(",").map(x=>x.trim());
                document.querySelectorAll('input[name="paisesAfectados"]').forEach(cb => {
                    cb.checked = list.includes(cb.value);
                });
            }

            // --- Recalcular y refrescar UI ---
            try {
                // Determine if 'Sin Afectación' was in the file and set the checkbox
                const afectacionText = getValue("Afectación Total");
                const sinAfectacionCheck = document.getElementById('sinAfectacionCheck');
                if (afectacionText === "Sin Afectación" && document.getElementById('horaInicio').value === "" && document.getElementById('horaFin').value === "") {
                    sinAfectacionCheck.checked = true;
                } else {
                    sinAfectacionCheck.checked = false;
                }
                toggleAfectacionTotal();
                calcularAfectacionTotal();
                handleTipoSistemaChange(); 
                generarYMostrarResultado();
            } catch(e){
                console.error("Error al refrescar la vista previa:", e);
            }

            alert("✅ Datos cargados desde el TXT y previsualización generada");
        };
        reader.readAsText(file);
        event.target.value = ""; // Permite recargar el mismo archivo
    }
    
    function hook(){
        var input = document.getElementById('inputCargarTXT');
        if (input && !input._hooked) {
            input.addEventListener('change', onChangeHandler);
            input._hooked = true;
        }
    }

    if (document.readyState === "loading") {
        document.addEventListener('DOMContentLoaded', hook);
    } else {
        hook();
    }
})();
</script>

</body>
</html>