<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Generador de Notificaciones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        
        body {
            font-family: 'Inter', sans-serif; 
            background-color: #f0f2f5; 
            display: flex;
            justify-content: center;
            align-items: flex-start; 
            min-height: 10vh; 
            padding: 20px; 
        }
        .container {
            background-color: #ffffff; 
            padding: 30px;
            border-radius: 12px; 
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); 
            max-width: 900px; 
            width: 100%; 
            margin-top: 20px; 
            position: relative; 
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600; 
            color: #333; 
        }
        input[type="text"],
        input[type="datetime-local"], 
        textarea,
        select {
            width: 100%; 
            padding: 12px;
            margin-bottom: 20px; 
            border: 1px solid #e2e8f0; 
            border-radius: 8px; 
            box-sizing: border-box; 
            font-size: 1rem; 
            transition: border-color 0.3s ease; 
        }
        input[type="text"]:focus,
        input[type="datetime-local"]:focus, 
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #6366f1; 
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); 
        }
        textarea {
            resize: vertical; 
            min-height: 60px; 
        }
        
        button {
            background-color: #a0aec0; /* Fondo gris por defecto */
            color: white;
            padding: 14px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem; 
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease; 
            width: auto; 
            display: inline-block; 
            margin-right: 15px; 
        }
        button:hover {
            background-color: #efb810; /* Color al pasar el puntero */
            transform: translateY(-2px); 
        }
        button:active {
            transform: translateY(0); 
        }
        
        #resultado {
            border: 2px dashed #cbd5e1; 
            padding: 25px;
            margin-top: 30px;
            background-color: #f8fafc; 
            border-radius: 10px;
            min-height: 150px; 
            color: #333;
            line-height: 1.6; 
        }
        #resultado h3 {
            font-size: 1.8rem;
            color: #1a202c;
            margin-bottom: 15px;
            border-bottom: 2px solid #e2e8f0; 
            padding-bottom: 10px;
        }
        #resultado p {
            margin-bottom: 10px;
        }
        #resultado strong {
            color: #4a5568;
        }
        
        .optional-field {
            margin-bottom: 20px;
            display: flex;
            align-items: center; 
        }
        .optional-field input[type="checkbox"] {
            width: auto; 
            margin-right: 10px; 
            margin-bottom: 0; 
        }
        .optional-field label {
            margin-bottom: 0; 
        }
        
        #enviarCorreoBtn {
            display: none;
        }
        
        .logo-img {
            position: absolute; 
            top: 10px; 
            left: 30px; 
            /*width: 200px;*/ 
            height: 80px; 
            object-fit: contain; 
        }
        
        select[multiple] {
            min-height: 100px; 
        }
        
        .country-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .country-item img {
            width: 38px;
            height: 26px;
            margin-left: 6px;
            border: 1px solid #ccc; 
        }
        
        .section-container {
            background-color: #e0f2f7; 
            padding: 24px; 
            margin-bottom: 24px; 
            border-radius: 10px; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); 
        }
        
        .servicio-porcentaje-item {
            display: flex;
            align-items: center;
            gap: 10px; 
            margin-top: 10px; 
        }
        .servicio-porcentaje-item input {
            width: 80px; 
            padding: 8px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        
        .notification-table {
            width: 100%;
            border-collapse: collapse; 
            margin-top: 20px;
        }
        .notification-table th,
        .notification-table td {
            padding: 10px 15px;
            border: 1px solid #e2e8f0; 
            text-align: left;
        }
        .notification-table th {
            background-color: #f0f4f8; 
            font-weight: 600;
            color: #2c5282; 
        }
        .blue-border-table {
            border: 2px solid #3182ce; 
        }
        .red-border-table {
            border: 2px solid #e53e3e; 
        }
        .notification-table tr:nth-child(even) {
            background-color: #f7fafc; 
        }
        .notification-table strong {
            color: #1a202c; 
        }
        
        .dynamic-image {
            max-width: 60px; 
            height: auto;
            margin-top: 10px;
            
        }
        .platform-images-container {
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
            margin-top: 10px;
            justify-content: center; 
        }
        .platform-images-container .platform-item {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.8rem;
            color: #555;
            width: 90px;
        }
        .platform-images-container .platform-item img {
            max-width: 80px;
            height: auto;
            margin-bottom: 4px;
        }
        .platform-images-container .platform-item span {
            display: block;
            text-align: center;
            width: 100%;
            margin-top: 4px;
            font-weight: 500;
        }

        
        .flag-images-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px; 
            margin-top: 5px;
            align-items: center; 
        }
        .flag-images-container .flag-item {
            display: flex;
            flex-direction: column; 
            align-items: center;
            text-align: center;
            font-size: 0.8rem;
            color: #555;
        }
        .flag-images-container img {
            width: 64px; 
            height: 44px;
            border: 1px solid #eee;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 4px; 
        }

        
        .orange-border-box {
            border: 3px solid #f97316; 
            padding: 15px;
            border-radius: 10px;
            flex-grow: 1; 
        }
        .blue-border-box {
            border: 3px solid #3b82f6; 
            padding: 20px;
            border-radius: 8px;
            flex-grow: 1; 
        }
        .flex-container-middle {
            display: flex;
            flex-wrap: wrap; 
            gap: 20px; 
            justify-content: space-around; 
            align-items: flex-start; 
        }
        .flex-item-middle {
            flex: 1; 
            min-width: 250px; 
        }

        
        .preview-section-title {
            font-size: 1.0rem; 
            font-weight: bold; 
            margin-bottom: 5px; 
            color: #1a202c; 
        }

        
        .preview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            border: 1px solid #ffffff; 
            background-color: #ffffff; 
        }
        .preview-grid-cell {
            background-color: #ffffff; 
            padding: 10px;
            display: flex; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .preview-grid-cell.spanning-row {
            grid-column: span 2; 
            text-align: center;
            align-items: flex-start;
            padding: 13px;
        }
        .preview-grid-cell.spanning-row.content-only {
             padding: 15px; 
             text-align: left;
             align-items: flex-start;
        }
        .preview-grid-cell .logo-container {
            display: flex;
            align-items: center;
            width: 100%;
            
        }
        .preview-grid-cell .logo-container img {
	    justify-content: left;
            max-width: 350px; 
            height: 350px; 
            object-fit: contain;
        }
        .preview-grid-cell .type-notification-image {
            justify-content: right;
	    max-width: 60px; 
            height: 60px; 
            object-fit: contain; 
            margin-top: 10;
        }
        .preview-grid-cell h4 {
            font-size: 1.3rem; 
            font-weight: bold;
            margin: 10px 0;
            text-align: center;
            width: 100%;
	    color: #3a73bd;
        }
        .preview-grid-cell .platform-images-container {
            justify-content: center; 
            display: flex; 
            flex-wrap: wrap;
            gap: 10px;
            width: 100%; 
        }
        .platform-images-container .platform-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.8rem;
            color: #555;
            width: 110px; /* MODIFIED: Increased width for larger images */
        }
        .platform-images-container .platform-item img {
            display: block;
            margin: 0 auto 4px auto;
            max-width: 80px;
            height: auto;
        }
        .platform-images-container .platform-item span {
            display: block;
            text-align: center;
            width: 100%;
            margin-top: 4px;
            font-weight: 500;
        }
        .preview-grid-cell .platform-images-container img {
            max-width: 60px; /* MODIFIED: Increased image size by 25% (80px -> 100px) */
            height: auto;
            display: block; 
        }
        .preview-grid-cell .description-text,
        .preview-grid-cell .considerations-text {
            font-size: 1rem;
            line-height: 1.2;
            text-align: left;
            width: 100%;
            font-weight: normal; 
            color: #333;
        }
        .preview-grid-cell .description-text strong,
        .preview-grid-cell .considerations-text strong {
            font-weight: bold;
            color: #1a202c;
        }
        .preview-grid-cell .flag-images-container {
            justify-content: center; 
            width: 100%;
        }
        .preview-grid-cell .flag-images-container img {
            width: 48px; 
            height: 32px;
        }
        .preview-grid-cell .flag-images-container .flag-item span {
            font-size: 0.7rem; 
        }
        .preview-section-content {
            font-size: 0.8rem;
            text-align: left;
            width: 100%;
            margin-left: 30px;
        }
        .preview-section-content strong {
            font-weight: bold;
        }

        
        .orange-bordered-cell {
            border: 5px solid #f97316; 
            border-radius: 8px; 
            box-sizing: border-box; 
        }

        
        .row-span-2 {
            grid-row: span 2;
        }

        
        .email-container .preview-grid-cell .logo-container img,
        .email-container .preview-grid-cell .type-notification-image {
            height: 60px; 
        }

    
#resultado {
    background: url('fondomsco.png') center center no-repeat;
    background-size: cover;
    crossorigin="anonymous"
}
.preview-grid-cell {
    background-color: rgba(255, 255, 255, 0.85); /* blanco semi-transparente */
}


/* === MODIFICACIONES PERSONALIZADAS === */
/* 1. 칈conos 25% m치s peque침os */
.preview-grid-cell .type-notification-image {
    max-width: 60px !important;
    height: 60px !important;
    object-fit: contain;
}
/* 2. Texto de tipo antes del t칤tulo */
.tipo-notificacion-texto {
    display: block;
    color: #3a73bd;
    font-size: 1.1rem;
    font-weight: bold;
    text-align: center;
    margin-bottom: 2px;
    width: 100%;
}
/* 3. Espacio m칤nimo entre im치genes y t칤tulo */
#resultado .preview-grid { gap: 6px !important; }
#resultado .preview-grid-cell { padding: 4px !important; }

</style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>

/* 1) Logo de Speedy en la previsualizaci칩n: pegado al margen del 치rea blanca */
#resultado .preview-grid .preview-grid-cell:first-child { 
  padding: 0 !important;
}
#resultado .preview-grid .preview-grid-cell:first-child > * {
  margin: 0 !important;
  padding: 0 !important;
}
#resultado .preview-grid .preview-grid-cell:first-child img {
  display: block;
  margin: 0 !important;
  height: 60px;            /* respeta la altura original del dise침o */
  object-fit: contain;
}

/* 2) Espacio m칤nimo entre secciones en la previsualizaci칩n */
#resultado .preview-grid { 
  gap: 8px !important;     /* antes 20px */
}
#resultado .preview-grid-cell { 
  padding: 6px !important; /* antes 10px */
  margin: 0 !important;
}
#resultado .preview-grid-cell.spanning-row,
#resultado .preview-grid-cell.content-only {
  padding: 8px !important; /* antes 15px */
}

/* T칤tulos y p치rrafos m치s compactos dentro del resultado */
#resultado .preview-section-title { 
  margin-bottom: 4px !important;
}
#resultado p { 
  margin-bottom: 4px !important;
}

/* Contenido de secciones tipo "Horario", etc. m치s cercano al t칤tulo */
#resultado .preview-section-content {
  margin-left: 10px !important; /* antes 30px */
}
</style>
<style>

/* >>> INYECCI칍N: asegurar que la imagen de tipo de notificaci칩n est칠 alineada a la derecha
   y que la previsualizaci칩n coincida exactamente con la imagen/PDF exportados. */
.preview-grid-cell .type-notification-image {
    display: block !important;
    margin-left: auto !important;
    margin-right: 0 !important;
    max-width: 60px !important;
    height: 60px !important;
    object-fit: contain !important;
}
/* Ajustes: asegurar que el 치rea resultado tenga tama침o fijo durante la captura */
#resultado {
    box-sizing: border-box !important;
    width: 700px !important;
    max-width: 700px !important;
}

</style>



<style>

/* >>> INYECCI칍N: centrar el 치rea de previsualizaci칩n (#resultado) */
#resultado {
    margin-left: auto !important;
    margin-right: auto !important;
}

</style>

<style>

/* >>> INYECCI칍N: espaciar logo y notification-image un 25% */
.preview-grid-cell .logo-container img {
    margin-left: 25% !important;
}
.preview-grid-cell .type-notification-image {
    margin-right: 25% !important;
}

</style>
</head>
<body>
<div id="langBar" style="
position:fixed; top:10px; right:10px; z-index:99999;
background:#fff; border:1px solid #ddd; padding:6px 10px;
border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,.15);
font-family:Arial; font-size:14px;">
  游깷 Language:
  <select id="langSelector" style="border:0; outline:none; font-weight:bold;">
    <option value="es">游쀯릖 Espa침ol</option>
    <option value="en">游쥟릖 English</option>
  </select>
</div>
<script>const USERNAME = "admin"; const PASSWORD = "12345"; document.write(` <div id="loginOverlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#f0f2f5;display:flex;justify-content:center;align-items:center;z-index:9999;"> <div style="background:#fff;padding:30px;border-radius:12px;box-shadow:0 5px 20px rgba(0,0,0,0.2);text-align:center;max-width:300px;"> <h2 style="margin-bottom:20px;color:#333;">Acceso Restringido</h2> <input type="text" id="loginUser" placeholder="Usuario" style="width:100%;margin-bottom:10px;padding:10px;border:1px solid #ccc;border-radius:6px;"><br> <input type="password" id="loginPass" placeholder="Contrase침a" style="width:100%;margin-bottom:15px;padding:10px;border:1px solid #ccc;border-radius:6px;"><br> <button onclick="checkLogin()" style="width:100%;padding:12px;background:#3a73bd;color:#fff;border:none;border-radius:6px;cursor:pointer;">Entrar</button> <p id="loginError" style="color:red;margin-top:15px;display:none;">Usuario o contrase침a incorrectos</p> </div> </div> `); function checkLogin(){ const u=document.getElementById("loginUser").value; const p=document.getElementById("loginPass").value; if(u===USERNAME && p===PASSWORD){ document.getElementById("loginOverlay").style.display="none"; }else{ document.getElementById("loginError").style.display="block"; } }</script>

<div class="container">
    <img alt="Logo de la empresa" class="logo-img rounded-full" crossorigin="anonymous" onerror="this.onerror=null;this.src='onerror.png';" src="speedylogo.png"/>
    <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">Generador de Notificaciones Interactivo</h1>
    <form class="space-y-6" id="generadorForm">
        <div class="section-container">
            <label for="tituloNotificacion">T칤tulo de la Notificaci칩n:</label>
            <textarea class="focus:ring-indigo-500 focus:border-red-500" id="tituloNotificacion" required="" placeholder="Escribe el T칤tulo de la Notificaci칩n (Obligatorio)..."></textarea>
        </div>
        <div class="section-container">
            <label for="tipoNotificacion">Tipo de Notificaci칩n:</label>
            <select class="focus:ring-indigo-500 focus:border-red-500" id="tipoNotificacion" required="">
                <option value="">Selecciona un tipo</option>
                <option value="Afectacion">[ Inicio de Afectaci칩n ]</option>
		<option value="ActualizacionAfectacion">[ Actualizaci칩n de Afectaci칩n ]</option>
		<option value="Restablecimiento">[ T칠rmino de Afectaci칩n ]</option>
                <option value="Intermitencia">[ Inicio de Intermitencia ]</option>
		<option value="ActualizacionIntermitencia">[ Actualizaci칩n de Intermitencia ]</option>
		<option value="Restablecimiento">[ T칠rmino de Intermitencia ]</option>
		<option value="Ventana de Mantenimiento">[ Ventana de Mantenimiento Programada ]</option>
		<option value="InicioVM">[ Inicia Ventana de Mantenimiento ]</option>
                <option value="Termino">[ T칠rmino de Ventana de Mantenimiento ]</option>
                <option value="Estabilizacion">[ Estabilizaci칩n ]</option>
                <option value="Rollback">[ Rollback ]</option>
                <option value="Cancelled">[ Cancelaci칩n ]</option>
                <option value="Informativa">[ Informativa ]</option>
                <option value="Termino">[ T칠rmino ]</option>
                <option value="Update">[ Update ]</option>
                <option value="Actualizacion">[ Actualizaci칩n ]</option>
                <option value="Upgrade">[ Upgrade ]</option>
                <option value="Downgrade">[ Downgrade ]</option>
                <option value="Errata">[ F칠 de erratas ]</option>
                <option value="Blanco">          </option>
            </select>
            <img alt="Imagen del tipo de notificaci칩n" class="dynamic-image" crossorigin="anonymous" id="imagenTipoNotificacion" src="" style="display: none;"/>
        </div>
        <div class="section-container">
            <label for="tipoSistema">Plataforma:</label>
            <select class="focus:ring-indigo-500 focus:border-red-500" id="tipoSistema" multiple="" required="" size="9">
                <option value="SMI">SMI</option>
                <option value="Mi Telcel App">Mi Telcel App</option>
                <option value="Mi Claro App">Mi Claro App</option>
                <option value="Apigee">Apigee</option>
                <option value="Contenedor">Contenedor</option>
                <option value="HUB">HUB</option>
                <option value="HUB IoT">HUB IoT</option>
                <option value="SMT">SMT</option>
                <option value="SMS HUB">SMS HUB</option>
                <option value="CMP">CMP</option>
                <option value="Claro M칰sica">Claro M칰sica</option>
                <option value="Claro Video">Claro Video</option>
                <option value="Netflix">Netflix</option>
                <option value="Disney">Disney</option>
                <option value="Amazon">Amazon</option>
                <option value="F1">F1</option>
                <option value="HBO">HBO</option>
                <option value="Fortinet">Fortinet</option>
                <option value="Infinitum">Infinitum</option>
                <option value="Telmex">Telmex</option>
                <option value="Internet">Internet</option>
                <option value="Active Directory">Active Directory</option>
                <option value="WiFi">WiFi</option>
                <option value="Unifi">Unifi</option>
                <option value="Splunk">Splunk</option>
                <option value="Kibana">Kibana</option>
                <option value="Dynatrace">Dynatrace</option>
                <option value="AppDynamics">AppDynamics</option>
                <option value="Mi Claro Chile">Mi Claro Chile</option>
                <option value="Mi Claro CENAM">Mi Claro CENAM</option>
                <option value="Mi Claro Per칰">Mi Claro Per칰</option>
                <option value="Chatbot">Chatbot</option> <option value="TelcelBot">TelcelBot</option>
                <option value="IT">Soporte IT</option>
                <option value="Plataformas Internas">Plataformas Internas</option>
            </select>
            <div class="platform-images-container" id="plataformasSeleccionadasContainer"></div>
        </div>
        <div class="section-container">
    		<label for="descripcionCorta">쮼n qu칠 consiste?</label>
   		 <textarea class="focus:ring-indigo-500 focus:border-red-500" id="descripcionCorta" placeholder="Describe en que consiste el incidente o situaci칩n..."></textarea>
	</div>
        <div class="section-container" style="display: none;">
            <label class="font-bold" for="consideracionesServicio">Consideraciones sobre el servicio:</label>
            <textarea class="focus:ring-indigo-500 focus:border-red-500" id="consideracionesServicio" placeholder="Detalles o notas adicionales sobre el servicio..."></textarea>
        </div>
        <div class="section-container">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="horaInicio">Hora de Inicio:</label>
                    <input class="focus:ring-indigo-500 focus:border-red-500" id="horaInicio" onchange="calcularAfectacionTotal()" type="datetime-local"/>
                </div>
                <div>
                    <label for="horaFin">Hora de Fin:</label>
                    <input class="focus:ring-indigo-500 focus:border-red-500" id="horaFin" onchange="calcularAfectacionTotal()" type="datetime-local"/>
                </div>
            </div>
            <div class="mt-4">
                <div class="flex items-center mb-2">
                    <input type="checkbox" id="sinAfectacionCheck" class="h-4 w-4 text-indigo-600 rounded mr-2" onclick="toggleAfectacionTotal()">
                    <label for="sinAfectacionCheck" class="text-sm text-gray-700">"Sin Afectaci칩n"</label>
                </div>
                <label>Afectaci칩n Total:<br></label>
                <p class="text-lg font-semibold text-gray-700" id="afectacionTotal">Sin Afectaci칩n</p>
            </div>
        </div>
        <div class="section-container">
            <label class="font-bold" for="equipoResponsableText">Equipo Responsable:</label>
            <div class="flex items-center gap-4 mb-4">
                <input class="flex-grow focus:ring-indigo-500 focus:border-red-500 mb-0" id="equipoResponsableText" placeholder="Introduce nuevo equipo responsable (No Listado)" type="text"/>
                <button class="px-4 py-2 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded-md transition-colors duration-200" onclick="agregarEquipoResponsable()" type="button">Agregar</button>
            </div>
            <select class="focus:ring-indigo-500 focus:border-red-500" id="equipoResponsableSelect" multiple="" size="10">
                <option value="SPEEDYMOVIL">SPEEDYMOVIL</option>
                <option value="CITI">CITI</option>
                <option value="TELCEL">TELCEL</option>
                <option value="APIGEE">APIGEE</option>
                <option value="SSO">SSO</option>
                <option value="TANGO">TANGO</option>
                <option value="HUAWEI">HUAWEI</option>
                <option value="ISVA">ISVA</option>
		<option value="INFORM츼TICA TELCEL">INFORM츼TICA TELCEL</option>
		<option value="SOPORTE INTERNO">SOPORTE INTERNO</option>
		<option value="DESARROLLO BACKEND">DESARROLLO APPS BACKEND</option>
		<option value="DESARROLLO FRONTEND">DESARROLLO APPS FRONTEND</option>
		<option value="INTEGRACI칍N SPEEDYMOVIL">INTEGRACI칍N SPEEDYMOVIL</option>
		<option value="CLARO CHILE">CLARO CHILE</option>
		<option value="CLARO PER칔">CLARO PER칔</option>
		<option value="CLARO ARGENTINA">CLARO ARGENTINA</option>
		<option value="CLARO COLOMBIA">CLARO COLOMBIA</option>
		<option value="CLARO CENAM">CLARO CENAM</option>
            </select>
        </div>
        <div class="section-container">
            <label class="font-bold" for="causaRaiz">Causa Ra칤z:</label>
            <textarea class="focus:ring-indigo-500 focus:border-red-500" id="causaRaiz" placeholder="Describe la causa ra칤z del incidente o situaci칩n..."></textarea>
        </div>
        <div class="section-container" id="serviciosAfectadosSection">
            <label class="font-bold" for="servicioAfectadoText">Servicios Afectados:</label>
            <div class="flex items-center gap-4 mb-4">
                <input class="flex-grow focus:ring-indigo-500 focus:border-red-500 mb-0" id="servicioAfectadoText" placeholder="Introduce nuevo servicio afectado (No Listado)" type="text"/>
                <button class="px-4 py-2 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded-md transition-colors duration-200" onclick="agregarServicioAfectado()" type="button">Agregar</button>
            </div>
            <select class="focus:ring-indigo-500 focus:border-red-500" id="servicioAfectadoSelect" multiple="" size="5">
                <option value="ChargeAmount">ChargeAmount</option>
                <option value="ObtainProfile">ObtainProfile</option>
                <option value="executeOperation">executeOperation</option>
                <option value="Login">Login</option>
            </select>
            <div class="mt-4" id="serviciosPorcentajeContainer">
            </div>
            <label class="font-bold mt-4" for="afectacionUsuarioFinal">Afectaci칩n al usuario final:</label>
            <textarea class="focus:ring-indigo-500 focus:border-red-500" id="afectacionUsuarioFinal" placeholder="Describe la afectaci칩n al usuario final..."></textarea>
        </div>
        <div class="section-container" id="enviarCorreoSection">
            <label class="font-bold" for="correoAdicionalText">Enviar para Vo.Bo.:</label>
            <div class="flex items-center gap-4 mb-4">
                <input class="flex-grow focus:ring-indigo-500 focus:border-red-500 mb-0" id="correoAdicionalText" placeholder="Introduce nuevo correo" type="text"/>
                <button class="px-4 py-2 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded-md transition-colors duration-200" onclick="agregarCorreoAdicional()" type="button">Agregar</button>
            </div>
            <select class="focus:ring-indigo-500 focus:border-red-500" id="listasDistribucionSelect" multiple="" size="5">
                <option value="aldo.castillo@speedymovil.com">aldo.castillo@speedymovil.com</option>
		<option value="sonia.aragon@speedymovil.com">sonia.aragon@speedymovil.com</option>
		<option value="abraham.quintero@speedymovil.com">abraham.quintero@speedymovil.com</option>
		<option value="irene.lopez@speedymovil.com">irene.lopez@speedymovil.com</option>
		<option value="monica.delacruz@speedymovil.com">monica.delacruz@speedymovil.com</option>
		<option value="brandon.soto@speedymovil.com">brandon.soto@speedymovil.com</option>
		<option value="guadalupe.rodriguez@speedymovil.com">guadalupe.rodriguez@speedymovil.com</option>
		<option value="jose.rosas@speedymovil.com">jose.rosas@speedymovil.com</option>
                <option value="eduardo.sierra@speedymovil.com">eduardo.sierra@speedymovil.com</option>
            </select>
        </div>
	<div class="section-container" id="enviarExternosSection">
    	    <label class="font-bold" for="paisExternosSelect">Listas de Distribuci칩n:</label>
   	    <select id="paisExternosSelect" class="focus:ring-indigo-500 focus:border-red-500 mb-4">
   	        <option value="">-- Selecciona un pa칤s/plataforma --</option>
        	<option value="Mexico">M칠xico</option>
        	<option value="Argentina">Argentina</option>
        	<option value="Colombia">Colombia</option>
        	<option value="Brasil">Brasil</option>
        	<option value="Chile">Chile</option>
        	<option value="Peru">Per칰</option>
        	</select>
            <div id="correosExternosContainer" class="bg-gray-50 border border-gray-300 rounded p-3 text-sm text-gray-700 mb-3" style="min-height:60px;">
                Selecciona un pa칤s/plataforma para ver los correos...
            </div>
            <button type="button" id="btnCopiarExternos" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-md">Copiar correos</button>
        </div>
        <div class="section-container">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Pa칤ses Afectados:</h3>
            <div class="flex items-center mb-4">
                <input class="form-checkbox h-5 w-5 text-indigo-600 rounded mr-2" id="selectAllCountries" type="checkbox"/>
                <label class="text-gray-700 font-medium" for="selectAllCountries">Seleccionar Todos los Pa칤ses</label>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="argentina.png" id="country_ar" name="paisesAfectados" type="checkbox" value="Argentina">
                    <img alt="Bandera de Argentina" crossorigin="anonymous" onerror="this.onerror=null;this.src='onerror.png';" src="argentina.png"/>
                    <label class="ml-2 text-gray-700" for="country_ar">Argentina</label>
                    </input></div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="brasil.png" id="country_br" name="paisesAfectados" type="checkbox" value="Brasil"/>
                    <img alt="Bandera de Brasil" crossorigin="anonymous" onerror="this.onerror=null;this.src='brasil.png';" src="brasil.png"/>
                    <label class="ml-2 text-gray-700" for="country_br">Brasil</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="chile.png" id="country_cl" name="paisesAfectados" type="checkbox" value="Chile"/>
                    <img alt="Bandera de Chile" crossorigin="anonymous" onerror="this.onerror=null;this.src='chile.png';" src="chile.png"/>
                    <label class="ml-2 text-gray-700" for="country_cl">Chile</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="colombia.png" id="country_co" name="paisesAfectados" type="checkbox" value="Colombia"/>
                    <img alt="Bandera de Colombia" crossorigin="anonymous" onerror="this.onerror=null;this.src='colombia.png';" src="colombia.png"/>
                    <label class="ml-2 text-gray-700" for="country_co">Colombia</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="costarica.png" id="country_cr" name="paisesAfectados" type="checkbox" value="Costa Rica"/>
                    <img alt="Bandera de Costa Rica" crossorigin="anonymous" onerror="this.onerror=null;this.src='costarica.png';" src="costarica.png"/>
                    <label class="ml-2 text-gray-700" for="country_cr">Costa Rica</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="ecuador.png" id="country_ec" name="paisesAfectados" type="checkbox" value="Ecuador"/>
                    <img alt="Bandera de Ecuador" crossorigin="anonymous" onerror="this.onerror=null;this.src='ecuador.png';" src="ecuador.png"/>
                    <label class="ml-2 text-gray-700" for="country_ec">Ecuador</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="elsalvador.png" id="country_sv" name="paisesAfectados" type="checkbox" value="El Salvador"/>
                    <img alt="Bandera de El Salvador" crossorigin="anonymous" onerror="this.onerror=null;this.src='elsalvador.png';" src="elsalvador.png"/>
                    <label class="ml-2 text-gray-700" for="country_sv">El Salvador</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="guatemala.png" id="country_gt" name="paisesAfectados" type="checkbox" value="Guatemala"/>
                    <img alt="Bandera de Guatemala" crossorigin="anonymous" onerror="this.onerror=null;this.src='guatemala.png';" src="guatemala.png"/>
                    <label class="ml-2 text-gray-700" for="country_gt">Guatemala</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="honduras.png" id="country_hn" name="paisesAfectados" type="checkbox" value="Honduras"/>
                    <img alt="Bandera de Honduras" crossorigin="anonymous" onerror="this.onerror=null;this.src='honduras.png';" src="honduras.png"/>
                    <label class="ml-2 text-gray-700" for="country_hn">Honduras</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="mexico.png" id="country_mx" name="paisesAfectados" type="checkbox" value="M칠xico"/>
                    <img alt="Bandera de M칠xico" crossorigin="anonymous" onerror="this.onerror=null;this.src='mexico.png';" src="mexico.png"/>
                    <label class="ml-2 text-gray-700" for="country_mx">M칠xico</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="nicaragua.png" id="country_ni" name="paisesAfectados" type="checkbox" value="Nicaragua"/>
                    <img alt="Bandera de Nicaragua" crossorigin="anonymous" onerror="this.onerror=null;this.src='nicaragua.png';" src="nicaragua.png"/>
                    <label class="ml-2 text-gray-700" for="country_ni">Nicaragua</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="panama.png" id="country_pa" name="paisesAfectados" type="checkbox" value="Panam치"/>
                    <img alt="Bandera de Panam치" crossorigin="anonymous" onerror="this.onerror=null;this.src='panama.png';" src="panama.png"/>
                    <label class="ml-2 text-gray-700" for="country_pa">Panam치</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="paraguay.png" id="country_py" name="paisesAfectados" type="checkbox" value="Paraguay"/>
                    <img alt="Bandera de Paraguay" crossorigin="anonymous" onerror="this.onerror=null;this.src='paraguay.png';" src="paraguay.png"/>
                    <label class="ml-2 text-gray-700" for="country_py">Paraguay</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="peru.png" id="country_pe" name="paisesAfectados" type="checkbox" value="Per칰"/>
                    <img alt="Bandera de Per칰" crossorigin="anonymous" onerror="this.onerror=null;this.src='peru.png';" src="peru.png"/>
                    <label class="ml-2 text-gray-700" for="country_pe">Per칰</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="puertorico.png" id="country_pr" name="paisesAfectados" type="checkbox" value="Puerto Rico"/>
                    <img alt="Bandera de Puerto Rico" crossorigin="anonymous" onerror="this.onerror=null;this.src='puertorico.png';" src="puertorico.png"/>
                    <label class="ml-2 text-gray-700" for="country_pr">Puerto Rico</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="dominicana.png" id="country_do" name="paisesAfectados" type="checkbox" value="Dominicana"/>
                    <img alt="Bandera de Rep. Dominicana" crossorigin="anonymous" onerror="this.onerror=null;this.src='dominicana.png';" src="dominicana.png"/>
                    <label class="ml-2 text-gray-700" for="country_do">Dominicana</label>
                </div>
                <div class="country-item">
                    <input class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-img="uruguay.png" id="country_uy" name="paisesAfectados" type="checkbox" value="Uruguay"/>
                    <img alt="Bandera de Uruguay" crossorigin="anonymous" onerror="this.onerror=null;this.src='uruguay.png';" src="uruguay.png"/>
                    <label class="ml-2 text-gray-700" for="country_uy">Uruguay</label>
                </div>
            </div>
        </div>
	<div class="flex justify-center items-center flex-wrap gap-4 mt-8 bg-purple-200 p-6 rounded-lg shadow-inner">
    		<button onclick="generarYMostrarResultado()" type="button">&nbsp;Generar Notificaci칩n y Previsualizar&nbsp;</button>==>
    		<button id="enviarCorreoBtn" onclick="generarHtmlParaCorreo()" type="button">&nbsp;Genera Correo para Vo.Bo.&nbsp;</button>/
    		<button id="btnExportImagen" onclick="generarImagen()" type="button" style="display:none;">&nbsp;Exportar como Imagen&nbsp;</button>/
    		<button id="btnExportPDF" onclick="generarPDF()" type="button" style="display:none;">&nbsp;Exportar como PDF&nbsp;</button>/
    		<button id="btnGuardarTXT" onclick="guardarComoTXT()" type="button" style="display:none;">&nbsp;Guardar como TXT&nbsp;</button>
            <button id="btnCargarTXT" type="button" onclick="cargarDesdeTXT()">&nbsp;Cargar desde TXT&nbsp;</button>
            <input type="file" id="inputCargarTXT" accept=".txt" style="display:none;" />
	</div>
    </form>
    <hr class="my-10 border-t-2 border-gray-200"/>
    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Previsualizaci칩n de Notificaci칩n</h2>
    <div id="resultado">
        <p class="text-gray-600 text-center">La previsualizacion se mostrar치 aqu칤 una vez generada.</p>
    </div>
</div>
<script>
    // Lista de correos por pa칤s
    const correosExternosPorPais = {
        "Mexico": ["mex@speedymovil.com", "sm-all@speedymovil.com"],
        "Argentina": ["arg@speedymovil.com"],
        "Colombia": ["col@speedymovil.com", "col-all@speedymovil.com"],
        "Brasil": ["bra@speedymovil.com"],
        "Chile": ["chi@speedymovil.com"],
        "Peru": ["per@speedymovil.com"]
    };

    /**
     * Funci칩n para formatear una cadena de fecha/hora ISO a formato DD/MM/AAAA HH:MM AM/PM para MOSTRAR en la previsualizaci칩n.
     * @param {string} dateString - Cadena de fecha y hora (e.g., "2023-10-26T15:30").
     * @returns {string} Fecha y hora formateada o '--'.
     */
    function formatDateTimeDDMMYYYY(dateString) {
        if (!dateString) return '--';
        const date = new Date(dateString);

        if (isNaN(date.getTime())) return '--'; // Manejar fechas inv치lidas

        const options = {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true // <<< MODIFICADO: Usar formato de 12 horas con AM/PM
        };
        
        // Usamos 'es-ES' para asegurar el orden d칤a/mes/a침o y AM/PM en min칰sculas.
        // El replace es para asegurar que el separador sea un espacio, no una coma.
        return date.toLocaleString('es-ES', options).replace(',', ' ').toLowerCase(); // <<< MODIFICADO: Se convierte a min칰sculas
    }


    /**
     * Funci칩n para calcular la duraci칩n de la afectaci칩n en D칈AS, Horas y Minutos (o "En Curso" / "Sin Afectaci칩n" - base).
     * **MODIFICADA: Ahora calcula d칤as si la duraci칩n excede 24 horas.**
     * @returns {string} Duraci칩n calculada.
     */
    function getDuracionCalculada() {
        const horaInicioInput = document.getElementById('horaInicio').value;
        const horaFinInput = document.getElementById('horaFin').value;
        
        if (!horaInicioInput && !horaFinInput) {
             return '-'; // Base: si no hay horas, es sin afectaci칩n.
        }

        if (horaInicioInput && !horaFinInput) {
            return 'En Curso'; // L칩gica de "En Curso"
        }

        if (!horaInicioInput || !horaFinInput) {
            return 'Sin Afectaci칩n'; // Faltan datos para calcular
        }

        const fechaInicio = new Date(horaInicioInput);
        const fechaFin = new Date(horaFinInput);

        if (isNaN(fechaInicio.getTime()) || isNaN(fechaFin.getTime())) {
            return 'Fechas inv치lidas';
        }
        if (fechaFin < fechaInicio) {
            return 'La hora de fin no puede ser anterior a la de inicio';
        }

        const diferenciaMilisegundos = fechaFin.getTime() - fechaInicio.getTime();
        
        if (diferenciaMilisegundos === 0) {
            return 'Sin Afectaci칩n';
        }
        
        // C츼LCULO DE D칈AS, HORAS Y MINUTOS
        let totalMinutos = Math.floor(diferenciaMilisegundos / (1000 * 60));
        
        const dias = Math.floor(totalMinutos / (60 * 24));
        totalMinutos %= (60 * 24); 
        
        const horas = Math.floor(totalMinutos / 60);
        const minutos = totalMinutos % 60;
        
        let resultadoString = '';

        if (dias > 0) {
            resultadoString += `${dias} ${dias === 1 ? 'd칤a' : 'd칤as'}`;
        }
        if (horas > 0) {
            if (resultadoString.length > 0) {
                resultadoString += ' - ';
            }
            resultadoString += `${horas} ${horas === 1 ? 'hora' : 'horas'}`;
        }
        if (minutos > 0) {
            if (resultadoString.length > 0) {
                resultadoString += ' - ';
            }
            resultadoString += `${minutos} ${minutos === 1 ? 'minuto' : 'minutos'}`;
        }

        // Caso borde: Si la duraci칩n es menor a un minuto pero mayor a 0ms (deber칤a ser handled por diferenciaMilisegundos === 0, pero como fallback)
        if (resultadoString.length === 0) {
            return 'Menos de un minuto';
        }
        
        return resultadoString;
    }


    /**
     * Funci칩n para calcular y mostrar la afectaci칩n total en D칈AS, Horas y Minutos,
     * incluyendo el estado de "Sin Afectaci칩n" si el checkbox est치 activo.
     */
    function calcularAfectacionTotal() {
        const sinAfectacionCheck = document.getElementById('sinAfectacionCheck');
        const afectacionTotalElement = document.getElementById('afectacionTotal');

        let duracionCalculada = getDuracionCalculada();
        
        if (sinAfectacionCheck.checked) {
            // Caso especial: Checkbox activo.
            if (duracionCalculada === 'Sin Afectaci칩n' || duracionCalculada.includes('Fechas inv치lidas') || duracionCalculada.includes('anterior')) {
                // Si la duraci칩n base es ya 'Sin Afectaci칩n' o un error, solo mostramos 'Sin Afectaci칩n'.
                afectacionTotalElement.textContent = 'Sin Afectaci칩n';
            } else {
                // Si hay duraci칩n (o est치 "En Curso"), la mostramos y le concatenamos " (Sin Afectaci칩n)".
                afectacionTotalElement.textContent = `${duracionCalculada} (Sin Afectaci칩n)`;
            }
        } else {
            // Checkbox inactivo: mostramos el resultado calculado
            afectacionTotalElement.textContent = duracionCalculada;
        }
    }


    /**
     * Function to toggle "Sin Afectaci칩n" text.
     */
    function toggleAfectacionTotal() {
        const sinAfectacionCheck = document.getElementById('sinAfectacionCheck');
        const horaInicioInput = document.getElementById('horaInicio');
        const horaFinInput = document.getElementById('horaFin');

        if (sinAfectacionCheck.checked) {
            // Al activarse, deshabilitamos la edici칩n de horas
            horaInicioInput.disabled = true;
            horaFinInput.disabled = true;
        } else {
            // Al desactivarse, rehabilitamos la edici칩n de horas
            horaInicioInput.disabled = false;
            horaFinInput.disabled = false;
        }
        // Llamamos al c치lculo para refrescar el texto
        calcularAfectacionTotal();
    }

    /**
     * Function to add a new option to the "Equipo Responsable" dropdown menu.
     */
    function agregarEquipoResponsable() {
        const equipoResponsableTextInput = document.getElementById('equipoResponsableText');
        const equipoResponsableSelect = document.getElementById('equipoResponsableSelect');
        const nuevoEquipo = equipoResponsableTextInput.value.trim();

        if (nuevoEquipo) {
            let exists = false;
            for (let i = 0; i < equipoResponsableSelect.options.length; i++) {
                if (equipoResponsableSelect.options[i].value === nuevoEquipo) {
                    exists = true;
                    break;
                }
            }

            if (!exists) {
                const newOption = document.createElement('option');
                newOption.value = nuevoEquipo;
                newOption.textContent = nuevoEquipo;
                equipoResponsableSelect.appendChild(newOption);
            }
            equipoResponsableTextInput.value = '';
        }
    }

    /**
     * Function to add a new option to the "Servicios Afectados" dropdown menu.
     */
    function agregarServicioAfectado() {
        const servicioAfectadoTextInput = document.getElementById('servicioAfectadoText');
        const servicioAfectadoSelect = document.getElementById('servicioAfectadoSelect');
        const nuevoServicio = servicioAfectadoTextInput.value.trim();

        if (nuevoServicio) {
            let exists = false;
            for (let i = 0; i < servicioAfectadoSelect.options.length; i++) {
                if (servicioAfectadoSelect.options[i].value === nuevoServicio) {
                    exists = true;
                    break;
                }
            }

            if (!exists) {
                const newOption = document.createElement('option');
                newOption.value = nuevoServicio;
                newOption.textContent = nuevoServicio;
                servicioAfectadoSelect.appendChild(newOption);
                handleServicioAfectadoChange();
            }
            servicioAfectadoTextInput.value = '';
        }
    }

    /**
     * Function to add a new email address to the "Vo.Bo." dropdown menu.
     */
    function agregarCorreoAdicional() {
        const correoAdicionalTextInput = document.getElementById('correoAdicionalText');
        const listasDistribucionSelect = document.getElementById('listasDistribucionSelect');
        const nuevoCorreo = correoAdicionalTextInput.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        if (nuevoCorreo && emailRegex.test(nuevoCorreo)) {
            let exists = false;
            for (let i = 0; i < listasDistribucionSelect.options.length; i++) {
                if (listasDistribucionSelect.options[i].value === nuevoCorreo) {
                    exists = true;
                    break;
                }
            }

            if (!exists) {
                const newOption = document.createElement('option');
                newOption.value = nuevoCorreo;
                newOption.textContent = nuevoCorreo;
                listasDistribucionSelect.appendChild(newOption);
            }
            correoAdicionalTextInput.value = '';
        } else if (nuevoCorreo) {
            alert('Por favor, introduce una direcci칩n de correo electr칩nico v치lida.');
        }
    }


    /**
     * Function to get all selected options from a multi-select dropdown.
     */
    function getSelectedOptions(selectElement) {
        const selected = [];
        for (let i = 0; i < selectElement.options.length; i++) {
            if (selectElement.options[i].selected) {
                selected.push(selectElement.options[i].value);
            }
        }
        return selected;
    }

    /**
     * Dynamically creates/removes percentage input fields for each selected service.
     */
    function handleServicioAfectadoChange() {
        const servicioAfectadoSelect = document.getElementById('servicioAfectadoSelect');
        const serviciosPorcentajeContainer = document.getElementById('serviciosPorcentajeContainer');
        serviciosPorcentajeContainer.innerHTML = '';
        const selectedServices = getSelectedOptions(servicioAfectadoSelect);

        selectedServices.forEach(service => {
            const serviceItemDiv = document.createElement('div');
            serviceItemDiv.classList.add('servicio-porcentaje-item');

            const serviceNameSpan = document.createElement('span');
            serviceNameSpan.textContent = service;
            serviceNameSpan.classList.add('font-medium', 'text-gray-700');

            const percentageInput = document.createElement('input');
            percentageInput.type = 'number';
            percentageInput.min = "0";
            percentageInput.max = "100";
            percentageInput.placeholder = '%';
            percentageInput.classList.add('focus:ring-indigo-500', 'focus:border-red-500');
            percentageInput.dataset.serviceName = service;

            serviceItemDiv.appendChild(serviceNameSpan);
            serviceItemDiv.appendChild(percentageInput);
            serviciosPorcentajeContainer.appendChild(serviceItemDiv);
        });
    }


    /**
     * Main function to generate the report and display it in the preview section.
     */
    function generarYMostrarResultado() {
        const tituloNotificacion = document.getElementById('tituloNotificacion').value.trim();
        const tituloNotificacionConSaltosDeLinea = tituloNotificacion.replace(/\n/g, '<br>');	
        const tipoNotificacionSelect = document.getElementById('tipoNotificacion');
        const tipoNotificacion = tipoNotificacionSelect.value;
        const tipoNotificacionTexto = tipoNotificacionSelect.options[tipoNotificacionSelect.selectedIndex].text;
        const tipoSistemaSelect = document.getElementById('tipoSistema');
        const plataformasSeleccionadas = getSelectedOptions(tipoSistemaSelect);
        const descripcionCorta = document.getElementById('descripcionCorta').value.trim();
        const consideracionesServicio = document.getElementById('consideracionesServicio').value.trim();
        const horaInicio = document.getElementById('horaInicio').value;
        const horaFin = document.getElementById('horaFin').value;
        const afectacionTotal = document.getElementById('afectacionTotal').textContent;
        const equipoResponsableSelectElement = document.getElementById('equipoResponsableSelect');
        const equiposResponsablesSeleccionados = getSelectedOptions(equipoResponsableSelectElement);
        const causaRaiz = document.getElementById('causaRaiz').value.trim();
        const afectacionUsuarioFinal = document.getElementById('afectacionUsuarioFinal').value.trim();

        const serviciosConPorcentaje = [];
        document.querySelectorAll('#serviciosPorcentajeContainer .servicio-porcentaje-item input[type="number"]').forEach(input => {
            const serviceName = input.dataset.serviceName;
            const percentage = input.value.trim();
            if (serviceName) {
                serviciosConPorcentaje.push(`${serviceName}${percentage ? ` (${percentage}%)` : ''}`);
            }
        });

        const resultadoDiv = document.getElementById('resultado');
        const enviarCorreoBtn = document.getElementById('enviarCorreoBtn');
        const paisesAfectadosCheckboxes = document.querySelectorAll('input[name="paisesAfectados"]:checked');

        const paisesAfectadosInfo = Array.from(paisesAfectadosCheckboxes).map(cb => ({
            name: cb.value,
            img: cb.dataset.img
        }));

        const plataformaImageMap = {
            "SMI": "smi.png", "Mi Telcel App": "mitelcel.png", "Mi Claro App": "miclaro.png",
            "Apigee": "apigee.png", "Contenedor": "contenedor.png", "HUB": "hub.png", "HUB IoT": "hubiot.png",
            "SMT": "smt.png", "SMS HUB": "smshub.png", "CMP": "cmp.png", "Claro M칰sica": "claromusica.png", "Claro Video": "clarovideo.png",
            "Netflix": "netflix.png", "Disney": "disney.png", "Amazon": "amazon.png",
            "F1": "f1.png", "HBO": "hbo.png", "Fortinet": "fortinet.png",
            "Infinitum": "infinitum.png", "Telmex": "telmex.png", "Internet": "internet.png",
            "Active Directory": "AD.png", "WiFi": "wifi.png", "Unifi": "unifi.png",
            "Splunk": "splunk.png", "Kibana": "kibana.png", "Dynatrace": "dynatrace.png", 
            "AppDynamics": "appdynamics.png", "Mi Claro Chile": "miclarochile.png", 
            "Mi Claro CENAM": "miclarocenam.png", "Mi Claro Per칰": "miclaroperu.png",
            "Chatbot": "chatbot.png", "TelcelBot": "telcelbot.png", "IT": "it.png", "Plataformas Internas": "plataformas.png" // ADDED
        };

        const tipoNotificacionImageMap = {
            "InicioVM": "engrane2.png", "Actualizacion": "engrane2.png", "Termino": "ok.png",
            "Restablecimiento": "ok.png", "Intermitencia": "warning.png", "Afectacion": "dead.png",
            "Ventana de Mantenimiento": "vm.png", "ActualizacionIntermitencia": "engrane3.png",
            "ActualizacionAfectacion": "engrane.png", "Rollback": "rollback.png", "Estabilizacion": "estabilizacion.png",
	    "Cancelled": "cancelled.png", "Informativa": "informativa.png","Actualizacion": "informativa.png", 
	    "Update": "update.png", "Upgrade": "upgrade.png", "Downgrade": "downgrade.png", "Errata": "errata.png" // ADDED
        };

        let tipoNotificacionImageHtml = '';
        if (tipoNotificacion && tipoNotificacionImageMap[tipoNotificacion]) {
            tipoNotificacionImageHtml = `<img src="${tipoNotificacionImageMap[tipoNotificacion]}" alt="${tipoNotificacion}" class="type-notification-image" onerror="this.onerror=null;this.src='onerror.png';" crossorigin="anonymous">`;
        }

        let plataformaImagesHtml = '';
        if (plataformasSeleccionadas.length > 0) {
            plataformaImagesHtml = `<div class="platform-images-container">${plataformasSeleccionadas.map(platform => 
                plataformaImageMap[platform] ? `<div class="platform-item">
                    <img src="${plataformaImageMap[platform]}" alt="${platform}" class="dynamic-image" onerror="this.onerror=null;this.src='onerror.png';" crossorigin="anonymous">
                    <span>${platform}</span>
                </div>` : ''
            ).join('')}</div>`;
        }

        let paisesAfectadosImagesHtml = '';
        if (paisesAfectadosInfo.length > 0) {
            paisesAfectadosImagesHtml = `<div class="flag-images-container">${paisesAfectadosInfo.map(country => `
                <div class="flag-item">
                    <img src="${country.img}" alt="Bandera de ${country.name}" title="${country.name}" onerror="this.onerror=null;this.src='onerror.png';" crossorigin="anonymous">
                    <span>${country.name}</span>
                </div>`).join('')}
            </div>`;
        }

        let plantillaHTML = `
            <div class="preview-grid">
                <div class="preview-grid-cell" style="text-align: left;">
                    <div><img src="speedylogo.png" alt="Logo Speedy" style="height:70px;" onerror="this.onerror=null;this.src='onerror.png';" crossorigin="anonymous"></div>
                </div>
                <div class="preview-grid-cell">${tipoNotificacionImageHtml}</div>
                <div class="preview-grid-cell spanning-row">
                    <span class="tipo-notificacion-texto">${tipoNotificacionTexto}</span>
                    <h4>${tituloNotificacionConSaltosDeLinea}</h4>
                </div>
                <div class="preview-grid-cell spanning-row">
                    <strong class="preview-section-title">Plataforma(s):</strong>
                    ${plataformaImagesHtml}
                </div>
                <div class="preview-grid-cell spanning-row content-only">
                    <p class="description-text"><strong>쮼n qu칠 consiste?:</strong><br>
		     <br> 
		     ${descripcionCorta || ''}</p>
                </div>
                <div class="preview-grid-cell orange-bordered-cell">
                    <strong class="preview-section-title">Horario:</strong>
                    <div class="preview-section-content">
                        <p><strong>Inicio:</strong> ${formatDateTimeDDMMYYYY(horaInicio)}</p>
                        <p><strong>Fin:</strong> ${formatDateTimeDDMMYYYY(horaFin)}</p>
                        <p><strong>Afectaci칩n Total:</strong><br> ${afectacionTotal}</p>
                    </div>
                </div>
                <div class="preview-grid-cell row-span-2" style="border: 5px solid #3b82f6; border-radius: 8px; padding: 15px;">
                    <strong class="preview-section-title">Servicio(s) Afectado(s):</strong>
                    <div class="preview-section-content"><p>${serviciosConPorcentaje.length > 0 ? serviciosConPorcentaje.join('<br>') : 'Por Definir'}</p></div>
                    <strong class="preview-section-title">Afectaci칩n al usuario final:</strong>
                    <div class="preview-section-content"><p>${afectacionUsuarioFinal || 'Por Definir'}</p></div>
                </div>
                <div class="preview-grid-cell" style="border: 5px solid #3b82f6; border-radius: 8px; padding: 15px;">
                    <strong class="preview-section-title">Responsable(s) y Causa Ra칤z:</strong>
                    <div class="preview-section-content">
                        <p><strong>Equipo(s) Responsable(s):</strong> ${equiposResponsablesSeleccionados.length > 0 ? equiposResponsablesSeleccionados.join(', ') : 'Por Definir'}</p>
                        <p><strong>Causa Ra칤z:</strong> ${causaRaiz || 'Por Definir'}</p>
                    </div>
                </div>
                <div class="preview-grid-cell spanning-row orange-bordered-cell">
                    <strong class="preview-section-title">Pa칤s(es) Afectado(s):</strong>
                    ${paisesAfectadosInfo.length > 0 ? paisesAfectadosImagesHtml : '<p></p>'}
                </div>
            </div>`;
            
        // ---> CORRECCI칍N DEL TEXTO LEGAL <---
        plantillaHTML += `
            <div class="mt-8 pt-4 border-t border-gray-200 text-xs text-gray-500 leading-relaxed" >
                <p>Si tienen alguna duda, favor de contactar a <a href="mailto:soporte@speedymovil.com" class="text-blue-600 hover:underline">soporte@speedymovil.com</a></p>
                <p>&nbsp;</p>
                <p>Saludos cordiales.</p>
                <p>&nbsp;</p>
                <p>&nbsp;</p>
                <p>Gerencia de Soporte</p>
                <p>&nbsp;</p>
                <p>Este mensaje es exclusivamente para el uso de la persona o entidad a quien est치 dirigido; contiene informaci칩n estrictamente confidencial y legalmente protegida, cuya divulgaci칩n es sancionada por la ley. Si el lector de este mensaje no es a quien est치 dirigido, ni se trata del empleado o agente responsable de esta informaci칩n, se le notifica por medio del presente, que su reproducci칩n y distribuci칩n, est치 estrictamente prohibida. Si Usted recibi칩 este comunicado por error, favor de notificarlo inmediatamente al remitente y destruir el mensaje. Todas las opiniones contenidas en este mail son propias del autor del mensaje y no necesariamente coinciden con las de Am칠rica M칩vil, S.A. de C.V. o alguna de sus empresas controladas, controladoras, afiliadas y subsidiarias.</p>
            </div>`;

        resultadoDiv.innerHTML = translatePreviewHTML(plantillaHTML);
        enviarCorreoBtn.style.display = 'inline-block';
        document.getElementById('btnExportImagen').style.display = 'inline-block';
        document.getElementById('btnExportPDF').style.display = 'inline-block';
        document.getElementById('btnGuardarTXT').style.display = 'inline-block';
    }
    
    function generarHtmlParaCorreo() {
        const titulo = document.getElementById('tituloNotificacion').value.trim();
        const tipoNotifSelect = document.getElementById('tipoNotificacion');
        const tipoNotifTexto = tipoNotifSelect.options[tipoNotifSelect.selectedIndex].text;
        const tipoNotifValue = tipoNotifSelect.value;
        const plataformas = getSelectedOptions(document.getElementById('tipoSistema'));
        const servicios = getSelectedOptions(document.getElementById('servicioAfectadoSelect'));
        const correosAdicionales = getSelectedOptions(document.getElementById('listasDistribucionSelect'));

        if (!titulo || plataformas.length === 0 || !tipoNotifTexto) {
            alert('Funci칩n no disponible sin previsualizaci칩n completada');
            return;
        }

        let primeraParteAsunto = '';
        if (tipoNotifTexto.includes('Afectaci칩n')) {
            primeraParteAsunto = 'Afectaci칩n';
        } else if (tipoNotifTexto.includes('Intermitencia')) {
            primeraParteAsunto = 'Intermitencia';
        } else if (tipoNotifTexto.includes('Ventana de Mantenimiento')) {
            primeraParteAsunto = 'Ventana de Mantenimiento';
        } else if (tipoNotifTexto.includes('Rollback')) {
            primeraParteAsunto = 'Rollback';
        } else if (tipoNotifTexto.includes('Cancelaci칩n')) {
            primeraParteAsunto = 'Cancelaci칩n';
        } else if (tipoNotifTexto.includes('Informativa')) {
            primeraParteAsunto = 'Informativa';
        } else if (tipoNotifTexto.includes('T칠rmino')) {
            primeraParteAsunto = 'T칠rmino';
        }
    
        let segundaParteAsunto = '';
        if (tipoNotifTexto.includes('Inicio de')) {
            segundaParteAsunto = 'Inicio';
        } else if (tipoNotifTexto.includes('Actualizaci칩n')) {
            segundaParteAsunto = 'Actualizaci칩n';
        } else if (tipoNotifTexto.includes('T칠rmino de')) {
            segundaParteAsunto = 'T칠rmino';
        } else if (tipoNotifTexto.includes('Ventana de Mantenimiento Programada')) {
            primeraParteAsunto = 'Ventana de Mantenimiento Programada'; // Correcci칩n para el primer corchete
            segundaParteAsunto = 'Ventana de Mantenimiento Programada';
        } else if (tipoNotifTexto.includes('Inicia Ventana de Mantenimiento')) {
            primeraParteAsunto = 'Ventana de Mantenimiento';
            segundaParteAsunto = 'Inicio';
        } else {
            segundaParteAsunto = tipoNotifTexto.replace(/\[|\]/g, '').trim();
        }

        const serviciosAfectadosString = servicios.length > 0 ? servicios.join(', ') : 'Por Definir';
        
        const subject = `[Notificaci칩n de ${primeraParteAsunto}] - [${segundaParteAsunto}] - [${plataformas.join(', ')}] [${titulo}] ${serviciosAfectadosString}`;

        const todosLosDestinatarios = new Set(['soporte@speedymovil.com', ...correosAdicionales]);
        const destinatariosString = Array.from(todosLosDestinatarios).join(',');
        window.location.href = `mailto:${destinatariosString}?subject=${encodeURIComponent(subject)}`;
    }

    function handleTipoNotificacionChange() {
        const tipoNotificacionSelect = document.getElementById('tipoNotificacion');
        const imagenTipoNotificacion = document.getElementById('imagenTipoNotificacion');
        const selectedValue = tipoNotificacionSelect.value;
        const imageMap = {
            "InicioVM": "engrane2.png", "Actualizacion": "engrane2.png", "Termino": "ok.png",
            "Restablecimiento": "ok.png", "Intermitencia": "warning.png", "Afectacion": "dead.png",
            "Ventana de Mantenimiento": "vm.png", "ActualizacionIntermitencia": "engrane3.png",
            "ActualizacionAfectacion": "engrane.png", "Rollback": "rollback.png", "Estabilizacion": "estabilizacion.png",
	    "Cancelled": "cancelled.png", "Informativa": "informativa.png", "Actualizacion": "informativa.png", 
	    "Update": "update.png", "Upgrade": "upgrade.png", "Downgrade": "downgrade.png", "Errata": "errata.png" // ADDED
        };
        if (selectedValue && imageMap[selectedValue]) {
            imagenTipoNotificacion.src = imageMap[selectedValue];
            imagenTipoNotificacion.style.display = 'block';
        } else {
            imagenTipoNotificacion.style.display = 'none';
            imagenTipoNotificacion.src = '';
        }
    }

    function handleTipoSistemaChange() {
        const tipoSistemaSelect = document.getElementById('tipoSistema');
        const plataformasSeleccionadasContainer = document.getElementById('plataformasSeleccionadasContainer');
        const selectedValues = getSelectedOptions(tipoSistemaSelect);
        plataformasSeleccionadasContainer.innerHTML = '';
        const imageMap = {
            "SMI": "smi.png", "Mi Telcel App": "mitelcel.png", "Mi Claro App": "miclaro.png",
            "Apigee": "apigee.png", "Contenedor": "contenedor.png", "HUB": "hub.png", "HUB IoT": "hubiot.png",
            "SMT": "smt.png", "SMS HUB": "smshub.png", "CMP": "cmp.png", "Claro M칰sica": "claromusica.png", "Claro Video": "clarovideo.png",
            "Netflix": "netflix.png", "Disney": "disney.png", "Amazon": "amazon.png",
            "F1": "f1.png", "HBO": "hbo.png", "Fortinet": "fortinet.png",
            "Infinitum": "infinitum.png", "Telmex": "telmex.png", "Internet": "internet.png",
            "Active Directory": "AD.png", "WiFi": "wifi.png", "Unifi": "unifi.png",
            "Splunk": "splunk.png", "Kibana": "kibana.png", "Dynatrace": "dynatrace.png", 
            "AppDynamics": "appdynamics.png", "Mi Claro Chile": "miclarochile.png", 
            "Mi Claro CENAM": "miclarocenam.png", "Mi Claro Per칰": "miclaroperu.png",
            "Chatbot": "chatbot.png", "TelcelBot": "telcelbot.png", "IT": "it.png", "Plataformas Internas": "plataformas.png" // ADDED
        };
        selectedValues.forEach(platform => {
            if (imageMap[platform]) {
                const platformItemDiv = document.createElement('div');
                platformItemDiv.classList.add('platform-item');
                const img = document.createElement('img');
                img.src = imageMap[platform];
                img.alt = platform;
                img.classList.add('dynamic-image');
                img.onerror = function() { this.onerror=null; this.src='onerror.png'; };
                platformItemDiv.appendChild(img);
                const span = document.createElement('span');
                span.textContent = platform;
                platformItemDiv.appendChild(span);
                plataformasSeleccionadasContainer.appendChild(platformItemDiv);
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('enviarCorreoBtn').style.display = 'none';
        calcularAfectacionTotal();
        document.getElementById('servicioAfectadoSelect').addEventListener('change', handleServicioAfectadoChange);
        handleServicioAfectadoChange();
        document.getElementById('tipoNotificacion').addEventListener('change', handleTipoNotificacionChange);
        document.getElementById('tipoSistema').addEventListener('change', handleTipoSistemaChange);
        handleTipoSistemaChange();
        document.getElementById('selectAllCountries').addEventListener('change', handleSelectAllCountries);
        document.getElementById('sinAfectacionCheck').addEventListener('change', toggleAfectacionTotal);

        // Event listeners para la secci칩n de externos
        document.getElementById('paisExternosSelect').addEventListener('change', function() {
            const pais = this.value;
            const contenedor = document.getElementById('correosExternosContainer');
            if (pais && correosExternosPorPais[pais]) {
                contenedor.innerHTML = correosExternosPorPais[pais].join('<br>');
            } else {
                contenedor.innerHTML = 'Selecciona un pa칤s/plataforma para ver los correos...';
            }
        });

        document.getElementById('btnCopiarExternos').addEventListener('click', function() {
            const pais = document.getElementById('paisExternosSelect').value;
            if (pais && correosExternosPorPais[pais]) {
                const texto = correosExternosPorPais[pais].join(', ');
                navigator.clipboard.writeText(texto)
                    .then(() => alert('Correos copiados al portapapeles: ' + texto))
                    .catch(() => alert('No se pudo copiar. Por favor, copia manualmente.'));
            } else {
                alert('Selecciona un pa칤s/plataforma v치lido para copiar sus correos');
            }
        });
    });

    function handleSelectAllCountries() {
        const selectAllCheckbox = document.getElementById('selectAllCountries');
        document.querySelectorAll('input[name="paisesAfectados"]').forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
    }

    function construirNombreArchivo() {
        const titulo = document.getElementById('tituloNotificacion').value.trim() || 'Notificacion';
        const tipoNotifSelect = document.getElementById('tipoNotificacion');
        const tipoNotifTexto = tipoNotifSelect.options[tipoNotifSelect.selectedIndex].text.replace(/\[|\]|\s/g, '') || 'Tipo';
        const plataformas = getSelectedOptions(document.getElementById('tipoSistema')).join(',') || 'Plataforma';
        const now = new Date();
        const timestamp = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}h${now.getMinutes().toString().padStart(2, '0')}m`;
        let baseName = `${titulo}-${tipoNotifTexto}-${plataformas}_${timestamp}`;
        return baseName.replace(/\s/g, '_').replace(/[\/\\?%*:,"|<>]/g, '-');
    }

    function generarImagen() {
        const resultado = document.getElementById('resultado');
        if (!resultado || resultado.innerText.includes("La previsualizacion se mostrar치 aqu칤")) {
            alert("Primero debes generar una notificaci칩n.");
            return;
        }
        const nombreArchivo = construirNombreArchivo();
        const originalMaxWidth = resultado.style.maxWidth;
        const originalWidth = resultado.style.width;
        resultado.style.border = 'none';
        resultado.style.maxWidth = '700px';
        resultado.style.width = '700px';

        html2canvas(resultado, { scale: 1.2, useCORS: true, allowTaint: false })
        .then(canvas => {
            const link = document.createElement('a');
            link.download = `${nombreArchivo}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }).catch(err => {
            alert("Error al generar la imagen: " + err.message);
            console.error(err);
        }).finally(() => {
            resultado.style.maxWidth = originalMaxWidth;
            resultado.style.width = originalWidth;
        });
    }

    function generarPDF() {
        const resultado = document.getElementById('resultado');
        if (!resultado || resultado.innerText.includes("La previsualizacion se mostrar치 aqu칤")) {
            alert("Primero debes generar una notificaci칩n.");
            return;
        }
        const nombreArchivo = construirNombreArchivo();
        const originalBorder = resultado.style.border;
        const originalMaxWidth = resultado.style.maxWidth;
        const originalWidth = resultado.style.width;
        
        resultado.style.border = 'none';
        resultado.style.maxWidth = '700px';
        resultado.style.width = '700px';

        html2canvas(resultado, { useCORS: true, allowTaint: false, scale: 1.2 })
        .then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const ratio = Math.min(pageWidth / canvas.width, pageHeight / canvas.height);
            const finalImgWidth = canvas.width * ratio;
            const finalImgHeight = canvas.height * ratio;
            const xPos = (pageWidth - finalImgWidth) / 2;

            pdf.addImage(imgData, 'PNG', xPos, 0, finalImgWidth, finalImgHeight);
            pdf.save(`${nombreArchivo}.pdf`);
        }).catch(err => {
            alert("Error al generar el PDF: " + err.message);
            console.error(err);
        }).finally(() => {
            resultado.style.border = originalBorder;
            resultado.style.maxWidth = originalMaxWidth;
            resultado.style.width = originalWidth;
        });
    }

    /**
     * Funci칩n para guardar la informaci칩n de la notificaci칩n en un archivo .txt.
     * 丘멆잺 AJUSTADO: Se guarda la hora de inicio/fin en formato ISO (AAAA-MM-DDTHH:MM)
     * para garantizar la correcta recarga en el campo datetime-local.
     */
    function guardarComoTXT() {
        const resultado = document.getElementById('resultado');
        if (!resultado || resultado.innerText.includes("La previsualizacion se mostrar치 aqu칤")) {
            alert("Primero debes generar una notificaci칩n para poder guardarla.");
            return;
        }

        // 1. Recolectar toda la informaci칩n de los campos
        const tituloNotificacion = document.getElementById('tituloNotificacion').value.trim();
        const tipoNotificacionSelect = document.getElementById('tipoNotificacion');
        const tipoNotificacionTexto = tipoNotificacionSelect.options[tipoNotificacionSelect.selectedIndex].text;
        const plataformasSeleccionadas = getSelectedOptions(document.getElementById('tipoSistema'));
        const descripcionCorta = document.getElementById('descripcionCorta').value.trim();
        const consideracionesServicio = document.getElementById('consideracionesServicio').value.trim();
        
        // --- CAPTURA DE HORAS EN FORMATO ISO PARA RECARGA SEGURA ---
        const horaInicioISO = document.getElementById('horaInicio').value; // AAAA-MM-DDTHH:MM
        const horaFinISO = document.getElementById('horaFin').value;       // AAAA-MM-DDTHH:MM
        
        // --- CAPTURA DE HORAS EN FORMATO LOCAL CON AM/PM PARA VISUALIZACI칍N EN TXT ---
        const horaInicioLocal = formatDateTimeDDMMYYYY(horaInicioISO); // <<< Ahora incluye AM/PM
        const horaFinLocal = formatDateTimeDDMMYYYY(horaFinISO);       // <<< Ahora incluye AM/PM

        const afectacionTotal = document.getElementById('afectacionTotal').textContent;
        const equiposResponsablesSeleccionados = getSelectedOptions(document.getElementById('equipoResponsableSelect'));
        const causaRaiz = document.getElementById('causaRaiz').value.trim();
        const afectacionUsuarioFinal = document.getElementById('afectacionUsuarioFinal').value.trim();

        const serviciosConPorcentaje = [];
        document.querySelectorAll('#serviciosPorcentajeContainer .servicio-porcentaje-item input[type="number"]').forEach(input => {
            const serviceName = input.dataset.serviceName;
            const percentage = input.value.trim();
            if (serviceName) {
                serviciosConPorcentaje.push(`${serviceName}${percentage ? ` (${percentage}%)` : ''}`);
            }
        });

        const paisesAfectadosCheckboxes = document.querySelectorAll('input[name="paisesAfectados"]:checked');
        const paisesAfectadosNombres = Array.from(paisesAfectadosCheckboxes).map(cb => cb.value);

        // 2. Formatear la informaci칩n como texto plano
        let contenidoTXT = `
========================================
RESUMEN DE LA NOTIFICACI칍N
========================================
#NOTA: Los campos con formato ISO se incluyen para la recarga de datos.

T칤tulo: ${tituloNotificacion || 'No especificado'}
Tipo de Notificaci칩n: ${tipoNotificacionTexto || 'No especificado'}

----------------------------------------
DETALLES
----------------------------------------

Plataforma(s): ${plataformasSeleccionadas.join(', ') || 'No especificadas'}
쮼n qu칠 consiste?: ${descripcionCorta || 'No especificado'}
Consideraciones sobre el servicio: ${consideracionesServicio || 'Ninguna'}

----------------------------------------
CRONOLOG칈A Y AFECTACI칍N
----------------------------------------

Hora de Inicio (Visual): ${horaInicioLocal}
Hora de Fin (Visual): ${horaFinLocal}
Afectaci칩n Total: ${afectacionTotal || 'No especificada'}
Hora de Inicio (ISO): ${horaInicioISO || '--'}
Hora de Fin (ISO): ${horaFinISO || '--'}

----------------------------------------
AN츼LISIS Y RESPONSABLES
----------------------------------------

Equipo(s) Responsable(s): ${equiposResponsablesSeleccionados.join(', ') || 'Por Definir'}
Causa Ra칤z: ${causaRaiz || 'Por Definir'}

----------------------------------------
IMPACTO
----------------------------------------

Servicio(s) Afectado(s): ${serviciosConPorcentaje.join(', ') || 'Por Definir'}
Afectaci칩n al usuario final: ${afectacionUsuarioFinal || 'Por Definir'}
Pa칤s(es) Afectado(s): ${paisesAfectadosNombres.join(', ') || 'Por Definir'}

========================================
Generado el ${new Date().toLocaleString()}
========================================
`;

        // 3. Crear el nombre del archivo usando la funci칩n existente
        const nombreArchivo = construirNombreArchivo() + '.txt';

        // 4. Crear un Blob y un enlace para descargar el archivo
        const blob = new Blob([contenidoTXT.trim()], { type: 'text/plain;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = nombreArchivo;

        // Simular clic para iniciar la descarga
        document.body.appendChild(link);
        link.click();

        // Limpiar
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
    }
</script>

<script>
// ==============================
// CARGAR DATOS DESDE TXT 
// ==============================
window.cargarDesdeTXT = function() {
    var fileInput = document.getElementById('inputCargarTXT');
    if (!fileInput) {
        alert('No se encontr칩 el input para cargar TXT.');
        return;
    }
    fileInput.click();
};

(function attachTXTHandler(){
    function onChangeHandler(event) {
        const file = event.target.files && event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const contenido = e.target.result || '';

            // Funci칩n mejorada para obtener el valor de un campo, limpiando saltos de l칤nea y el label
            const getValue = (label) => {
                const regex = new RegExp(`^${label}:[\\s]*(.*?)[\\s]*$`, "m");
                const match = contenido.match(regex);
                return match ? match[1].trim() : "";
            };

            // Funci칩n para seleccionar m칰ltiples opciones.
            function selectOptions(selectElement, valuesString) {
                if (!valuesString || valuesString.includes("No especificado") || valuesString.includes("Por Definir")) {
                    Array.from(selectElement.options).forEach(opt => opt.selected = false);
                    return;
                }
                const list = valuesString.split(",").map(x => x.trim()).filter(Boolean);
                let existingOptions = Array.from(selectElement.options).map(opt => opt.value);

                list.forEach(item => {
                    let match = item.match(/^(.*?)(?:\s\(\d+%\))?$/);
                    let itemName = match ? match[1].trim() : item.trim();
                    
                    if (!existingOptions.includes(itemName) && itemName) {
                        const newOption = document.createElement('option');
                        newOption.value = itemName;
                        newOption.textContent = itemName;
                        selectElement.appendChild(newOption);
                    }
                });

                Array.from(selectElement.options).forEach(opt => {
                    opt.selected = list.some(loadedItem => {
                        let match = loadedItem.match(/^(.*?)(?:\s\(\d+%\))?$/);
                        let loadedItemName = match ? match[1].trim() : loadedItem.trim();
                        return loadedItemName === opt.value;
                    });
                });
            }
            
            let v;

            // 1. Campos de texto
            v = getValue("T칤tulo"); if (v) { document.getElementById('tituloNotificacion').value = v; }
            v = getValue("쮼n qu칠 consiste\\?"); if (v) { document.getElementById('descripcionCorta').value = v; }
            v = getValue("Consideraciones sobre el servicio"); if (v) { document.getElementById('consideracionesServicio').value = v; }
            v = getValue("Causa Ra칤z"); if (v) { document.getElementById('causaRaiz').value = v; }
            v = getValue("Afectaci칩n al usuario final"); if (v) { document.getElementById('afectacionUsuarioFinal').value = v; }


            // 2. Tipo de Notificaci칩n
            v = getValue("Tipo de Notificaci칩n").replace(/\[|\]/g,"").trim();
            if (v) {
                let sel = document.getElementById('tipoNotificacion');
                Array.from(sel.options).forEach(opt => {
                    let t = (opt.text||"").replace(/\[|\]/g,"").trim();
                    if (t === v) opt.selected = true;
                });
            }

            // 3. Plataforma(s)
            v = getValue("Plataforma\\(s\\)");
            selectOptions(document.getElementById('tipoSistema'), v);
            
            // 4. Horas (CR칈TICO: Carga el valor ISO directamente)
            v = getValue("Hora de Inicio \\(ISO\\)"); 
            document.getElementById('horaInicio').value = (v === '--') ? '' : v; 
            v = getValue("Hora de Fin \\(ISO\\)"); 
            document.getElementById('horaFin').value = (v === '--') ? '' : v; 
            
            // 5. Equipo(s) Responsable(s)
            v = getValue("Equipo\\(s\\) Responsable\\(s\\)");
            selectOptions(document.getElementById('equipoResponsableSelect'), v);

            // 6. Servicio(s) Afectado(s) y Porcentajes
            v = getValue("Servicio\\(s\\) Afectado\\(s\\)");
            if (v) {
                const servicesWithPercentages = v.split(',').map(item => {
                    const match = item.trim().match(/^(.*?)(?:\s\((\d+)%\))?$/);
                    return match ? { name: match[1].trim(), percentage: match[2] || null } : null;
                }).filter(s => s && s.name && s.name !== "Por Definir");

                const serviceNames = servicesWithPercentages.map(s => s.name);
                const selSrv = document.getElementById('servicioAfectadoSelect');
                
                // Asegura que las opciones existan y las selecciona
                selectOptions(selSrv, serviceNames.join(', '));
                
                // Llama para generar los inputs de porcentaje
                handleServicioAfectadoChange();
                
                // Rellena los porcentajes
                servicesWithPercentages.forEach(service => {
                    if (service.percentage !== null) {
                        const input = document.querySelector(`#serviciosPorcentajeContainer input[data-service-name="${service.name}"]`);
                        if (input) input.value = service.percentage;
                    }
                });
            }


            // 7. Pa칤s(es) Afectados
            v = getValue("Pa칤s\\(es\\) Afectado\\(s\\)");
            if (v) {
                let list = v.split(",").map(x=>x.trim());
                document.querySelectorAll('input[name="paisesAfectados"]').forEach(cb => {
                    cb.checked = list.includes(cb.value);
                });
            }

            // --- Recalcular y refrescar UI ---
            try {
                // Sincroniza el checkbox "Sin Afectaci칩n"
                const afectacionText = getValue("Afectaci칩n Total");
                const sinAfectacionCheck = document.getElementById('sinAfectacionCheck');
                // L칩gica de carga AJUSTADA: Si el texto CONTIENE "Sin Afectaci칩n", activa el checkbox.
                if (afectacionText.includes("Sin Afectaci칩n")) {
                    sinAfectacionCheck.checked = true;
                } else {
                    sinAfectacionCheck.checked = false;
                }
                toggleAfectacionTotal();
                calcularAfectacionTotal();
                handleTipoSistemaChange(); 
                generarYMostrarResultado();
            } catch(e){
                console.error("Error al refrescar la vista previa:", e);
            }

            alert("九 Datos cargados desde el TXT y previsualizaci칩n generada. (Requiere un TXT generado con esta 칰ltima versi칩n)");
        };
        reader.readAsText(file);
        event.target.value = ""; // Permite recargar el mismo archivo
    }
    
    function hook(){
        var input = document.getElementById('inputCargarTXT');
        if (input && !input._hooked) {
            input.addEventListener('change', onChangeHandler);
            input._hooked = true;
        }
    }

    if (document.readyState === "loading") {
        document.addEventListener('DOMContentLoaded', hook);
    } else {
        hook();
    }
})();
</script>
<script>
/* =========================
   I18N PRO ENGINE v1.0
   Zero DOM breaking
========================= */

const I18N = {
  es: {
    "Generador de Notificaciones Interactivo":"Generador de Notificaciones Interactivo:",
    "T칤tulo de la Notificaci칩n:":"T칤tulo de la Notificaci칩n:",
    "Tipo de Notificaci칩n:":"Tipo de Notificaci칩n:",
    "Plataforma:":"Plataforma:",
    "쮼n qu칠 consiste?":"쮼n qu칠 consiste?",
    "Hora de Inicio:":"ora de Inicio:",
    "Hora de Fin:":"Hora de Fin:",
    "Afectaci칩n Total:":"Afectaci칩n Total:",
    "Equipo Responsable:":"Equipo Responsable:",
    "Causa Ra칤z:":"ausa Ra칤z:",
    "Servicios Afectados:":"Servicios Afectados:",
    "Afectaci칩n al usuario final:":"Afectaci칩n al usuario final:",
    "Enviar para Vo.Bo.:":"Enviar para Vo.Bo.:",
    "Listas de Distribuci칩n:":"Listas de Distribuci칩n:",
    "Pa칤ses Afectados:":"Pa칤ses Afectados:",
    "Seleccionar Todos los Pa칤ses":"Seleccionar Todos los Pa칤ses",
    "Generar Notificaci칩n y Previsualizar":"Generar Notificaci칩n y Previsualizar",
    "Genera Correo para Vo.Bo.":"Genera Correo para Vo.Bo.",
    "Exportar como Imagen":"Exportar como Imagen",
    "Exportar como PDF":"Exportar como PDF",
    "Guardar como TXT":"Guardar como TXT",
    "Cargar desde TXT":"Cargar desde TXT"
  },

  en: {
    "Generador de Notificaciones Interactivo":"Interactive Notification Generator",
    "T칤tulo de la Notificaci칩n:":"Notification Title:",
    "Tipo de Notificaci칩n:":"Notification Type:",
    "Plataforma:":"Platform:",
    "쮼n qu칠 consiste?":"Description:",
    "Hora de Inicio:":"Start Time:",
    "Hora de Fin:":"End Time:",
    "Afectaci칩n Total:":"Total Impact:",
    "Equipo Responsable:":"Responsible Team:",
    "Causa Ra칤z:":"Root Cause:",
    "Servicios Afectados:":"Affected Services:",
    "Afectaci칩n al usuario final:":"End User Impact:",
    "Enviar para Vo.Bo.":"Send for Approval:",
    "Listas de Distribuci칩n:":"Distribution Lists:",
    "Pa칤ses Afectados:":"Affected Countries:",
    "Seleccionar Todos los Pa칤ses":"Select All Countries",
    "Generar Notificaci칩n y Previsualizar":"Generate Notification & Preview",
    "Genera Correo para Vo.Bo.":"Generate Approval Email",
    "Exportar como Imagen":"Export as Image",
    "Exportar como PDF":"Export as PDF",
    "Guardar como TXT":"Save as TXT",
    "Cargar desde TXT":"Load from TXT",
    "Horario":"Schedule",
    "Hora de Inicio":"Start Time",
    "Hora de Fin":"End Time",
    "Afectaci칩n Total":"Total Impact",
    "Sin Afectaci칩n":"No Impact",
    "Equipo Responsable":"Responsible Team",
    "Servicios Afectados":"Affected Services",
    "Causa Ra칤z":"Root Cause",
    "Afectaci칩n al usuario final":"End User Impact",
    "Pa칤ses Afectados":"Affected Countries",
    "Descripci칩n":"Description",
    "Consideraciones":"Considerations",
    "Plataforma":"Platform",
    "Tipo de Notificaci칩n":"Notification Type"
  }
};

/* Core translator */
function i18nApply(lang) {
  localStorage.setItem("lang", lang);
  const dict = I18N[lang];

  document.querySelectorAll("label, button, h1, h2, h3, h4, span").forEach(el=>{
    const t = el.innerText.trim();
    if(dict[t]) el.innerText = dict[t];
  });

  /* Hook for preview + email generation */
  window.__CURRENT_LANG = lang;
}

/* Auto detect */
function detectLang() {
  const stored = localStorage.getItem("lang");
  if(stored) return stored;
  return navigator.language.startsWith("es") ? "es" : "en";
}

document.addEventListener("DOMContentLoaded",()=>{
  const sel = document.getElementById("langSelector");
  const lang = detectLang();
  sel.value = lang;
  i18nApply(lang);
  sel.addEventListener("change", e=> i18nApply(e.target.value));
});
</script>
<script>
/* Runtime dictionary for dynamic content */
const RUNTIME_I18N = {
  en: {
    "Afectaci칩n":"Impact",
    "Restablecimiento":"Restoration",
    "Intermitencia":"Intermittency",
    "Ventana de Mantenimiento":"Maintenance Window",
    "Sin Afectaci칩n":"No Impact"
  }
};

function translateRuntime(text){
  const lang = window.__CURRENT_LANG || "es";
  if(lang==="es") return text;
  for(const k in RUNTIME_I18N.en){
    text = text.replaceAll(k, RUNTIME_I18N.en[k]);
  }
  return text;
}

/* PATCH generar preview sin tocar tu funci칩n original */
const originalGenerar = window.generarYMostrarResultado;
if(originalGenerar){
  window.generarYMostrarResultado = function(){
    originalGenerar();
    if(window.__CURRENT_LANG==="en"){
      document.querySelectorAll("#resultado *").forEach(el=>{
        if(el.childNodes.length===1 && el.innerText){
          el.innerText = translateRuntime(el.innerText);
        }
      });
    }
  };
}
</script>
<script>
(function(){
  const original = window.generarYMostrarResultado;
  if (!original) return;

  window.generarYMostrarResultado = function() {
    original(); // genera preview normal

    if (window.__CURRENT_LANG === "en") {
      const res = document.getElementById("resultado");
      res.innerHTML = translatePreviewHTML(res.innerHTML);
    }
  };
})();
</script>
<script>
const previewObserver = new MutationObserver(() => {
  if (window.__CURRENT_LANG === "en") {
    const res = document.getElementById("resultado");
    res.innerHTML = translatePreviewHTML(res.innerHTML);
  }
});

document.addEventListener("DOMContentLoaded", () => {
  const res = document.getElementById("resultado");
  if(res){
    previewObserver.observe(res, { childList: true, subtree: true });
  }
});
</script>
<script>
const PREVIEW_I18N = {
  "Horario":"Schedule",
  "Hora de Inicio":"Start Time",
  "Hora de Fin":"End Time",
  "Afectaci칩n Total":"Total Impact",
  "Sin Afectaci칩n":"No Impact",
  "Equipo Responsable":"Responsible Team",
  "Servicios Afectados":"Affected Services",
  "Causa Ra칤z":"Root Cause",
  "Afectaci칩n al usuario final":"End User Impact",
  "Pa칤ses Afectados":"Affected Countries",
  "Plataforma":"Platform",
  "Tipo de Notificaci칩n":"Notification Type"
};

function translatePreviewDOM() {
  if (window.__CURRENT_LANG !== "en") return;
  const res = document.getElementById("resultado");
  if (!res) return;

  const walker = document.createTreeWalker(res, NodeFilter.SHOW_TEXT);
  let node;
  while (node = walker.nextNode()) {
    const t = node.nodeValue.trim();
    if (PREVIEW_I18N[t]) node.nodeValue = PREVIEW_I18N[t];
  }
}

/* Observa cambios en la vista previa */
document.addEventListener("DOMContentLoaded", () => {
  const res = document.getElementById("resultado");
  if (!res) return;

  const observer = new MutationObserver(() => translatePreviewDOM());
  observer.observe(res, { childList: true, subtree: true });
});
</script>
<script>
const PREVIEW_TRANSLATIONS = {
  "Horario": "Schedule",
  "Hora de Inicio": "Start Time",
  "Hora de Fin": "End Time",
  "Equipo Responsable": "Responsible Team",
  "Servicios Afectados": "Affected Services",
  "Causa Ra칤z": "Root Cause",
  "Afectaci칩n Total": "Total Impact",
  "Sin Afectaci칩n": "No Impact",
  "Afectaci칩n al usuario final": "End User Impact",
  "Pa칤ses Afectados": "Affected Countries",
  "Tipo de Notificaci칩n": "Notification Type",
  "Plataforma": "Platform"
};

function translatePreviewHTML(html) {
  if (window.__CURRENT_LANG !== "en") return html;
  for (const es in PREVIEW_TRANSLATIONS) {
    html = html.replaceAll(es, PREVIEW_TRANSLATIONS[es]);
  }
  return html;
}
</script>
<script>
const _set = Element.prototype.innerHTML.__lookupSetter__("innerHTML");
Object.defineProperty(Element.prototype,"innerHTML",{set(v){
 if(window.__CURRENT_LANG==="en") v = translatePreviewHTML(v);
 _set.call(this,v);
}});
</script>

</body>

</html>